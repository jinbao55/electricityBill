## è¾°åŸŸç”µè¡¨ç”¨ç”µå¯è§†åŒ–ï¼ˆFlaskï¼‰

[![Docker Build](https://github.com/jinbao55/electricitybill/actions/workflows/docker-build.yml/badge.svg)](https://github.com/jinbao55/electricitybill/actions/workflows/docker-build.yml)

### é¡¹ç›®ç›®çš„
æœ¬é¡¹ç›®é€šè¿‡å®šæ—¶æŠ“å–ä½™é¢ã€å…¥åº“ï¼Œå¹¶è®¡ç®—"å½“æ—¥/è¿‘7å¤©/è¿‘30å¤©"çš„ç”¨ç”µè¶‹åŠ¿ï¼Œè®©æ‰‹æœºç«¯ç›´è§‚æŸ¥çœ‹ç”¨ç”µé‡ä¸ä½™é¢å˜åŒ–ã€‚

### ä¸»è¦åŠŸèƒ½
- **H5 é¡µé¢**ï¼ˆç§»åŠ¨ç«¯ä¼˜å…ˆï¼‰ï¼š
  - é¡¶éƒ¨ KPIï¼šå½“æ—¥ç”¨ç”µã€å½“å‰ä½™é¢ã€è¾ƒæ˜¨æ—¥/è¾ƒä¸Šå‘¨æœŸã€é¢„è®¡å¯ç”¨å¤©æ•°
  - ä¸¤å¼ å›¾è¡¨ï¼šç”¨ç”µé‡ï¼ˆæŠ˜çº¿å›¾ï¼‰+ ä½™é¢ï¼ˆæŸ±çŠ¶å›¾ï¼‰
  - æ”¯æŒé€‰æ‹©æ—¥æœŸæˆ–åˆ‡æ¢"ä»Šæ—¥/è¿‘7å¤©/è¿‘30å¤©"æ¨¡å¼
  - æ•°å€¼ç»Ÿä¸€ä¿ç•™ä¸¤ä½å°æ•°ï¼Œæ¨ªå‘å¯æ»‘åŠ¨
  - **å……å€¼è®°å½•åŠŸèƒ½**ï¼šè‡ªåŠ¨è¯†åˆ«å……å€¼è¡Œä¸ºå¹¶è®°å½•å……å€¼å†å²
- **åç«¯ API**ï¼š`/data`ã€`/kpi`ã€`/period_kpi`ã€`/fetch`ã€`/recharge_history`ã€`/test_notification`
- **å®šæ—¶æŠ“å–**ï¼šAPScheduler åå°ä»»åŠ¡ï¼Œé»˜è®¤æ¯ 300 ç§’æŠ“å–ä¸€æ¬¡
- **æ€§èƒ½ä¼˜åŒ–**ï¼šä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢å’Œé¡µé¢æ¸²æŸ“æ€§èƒ½
- **å¾®ä¿¡é€šçŸ¥**ï¼šæ”¯æŒServeré…±å¾®ä¿¡æ¨é€ï¼Œæ¯æ—¥9ç‚¹è‡ªåŠ¨å‘é€ç”¨ç”µæŠ¥å‘Š

### ç³»ç»Ÿä¾èµ–
- Python 3.9+
- Docker + Docker Compose
- MySQL æ•°æ®åº“

### æ•°æ®åº“è¡¨ç»“æ„
```sql
CREATE TABLE IF NOT EXISTS electricity_balance (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  meter_no VARCHAR(64) NOT NULL,
  remain DECIMAL(10,2) NOT NULL,
  collected_at DATETIME NOT NULL,
  KEY idx_meter_time (meter_no, collected_at),
  UNIQUE KEY uk_meter_collected (meter_no, collected_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

## ğŸš€ å¿«é€Ÿéƒ¨ç½²

### æ–¹æ³•ä¸€ï¼šä¸€é”®éƒ¨ç½²ï¼ˆæ¨èï¼‰
```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/jinbao55/electricitybill.git
cd electricitybill

# 2. é…ç½®ç¯å¢ƒå˜é‡
cp env.example .env
nano .env  # ä¿®æ”¹æ•°æ®åº“é…ç½®

# 3. å¯åŠ¨æœåŠ¡
./deploy.sh start
```

### æ–¹æ³•äºŒï¼šæ‰‹åŠ¨ Docker éƒ¨ç½²
```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/jinbao55/electricitybill.git
cd electricitybill

# 2. é…ç½®ç¯å¢ƒ
cp env.example .env
nano .env

# 3. å¯åŠ¨æœåŠ¡
docker-compose up -d --build
```

### æ–¹æ³•ä¸‰ï¼šæœ¬åœ°å¼€å‘
```bash
python3 -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
python main.py
```

## âš™ï¸ ç¯å¢ƒé…ç½®

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š
```bash
# æ•°æ®åº“é…ç½®
DB_HOST=your-database-host
DB_PORT=3306
DB_USER=your-username
DB_PASSWORD=your-password
DB_NAME=your-database

# åº”ç”¨é…ç½®
FETCH_INTERVAL_SECONDS=300  # æ•°æ®æŠ“å–é—´éš”ï¼ˆç§’ï¼‰

# Serveré…±å¾®ä¿¡é€šçŸ¥é…ç½®ï¼ˆå¯é€‰ï¼‰
SERVER_CHAN_KEY_1=your-server-chan-key-1  # è®¾å¤‡1çš„SendKey
SERVER_CHAN_KEY_2=your-server-chan-key-2  # è®¾å¤‡2çš„SendKey
```

## ğŸ”§ æœåŠ¡ç®¡ç†

### é¦–æ¬¡éƒ¨ç½²
```bash
./deploy.sh start
```

### æ—¥å¸¸æ›´æ–°
```bash
./update.sh  # æ‹‰å–æœ€æ–°ä»£ç å¹¶é‡æ–°æ„å»º
```

### æœåŠ¡ç®¡ç†
```bash
./deploy.sh status    # æŸ¥çœ‹æœåŠ¡çŠ¶æ€
./deploy.sh logs      # æŸ¥çœ‹æœåŠ¡æ—¥å¿—
./deploy.sh restart   # é‡å¯æœåŠ¡
./deploy.sh stop      # åœæ­¢æœåŠ¡
```

### æ‰‹åŠ¨ Docker å‘½ä»¤
```bash
docker-compose ps           # æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker-compose logs -f      # æŸ¥çœ‹å®æ—¶æ—¥å¿—
docker-compose restart      # é‡å¯æœåŠ¡
docker-compose down         # åœæ­¢æœåŠ¡
```

## ğŸŒ è®¿é—®æœåŠ¡

éƒ¨ç½²å®Œæˆåè®¿é—®ï¼š`http://your-server-ip:9136`

## ğŸ“Š åŠŸèƒ½ç‰¹æ€§

### æ™ºèƒ½æ•°æ®å¤„ç†
- **00ç‚¹ä½™é¢æ˜¾ç¤º**ï¼šæ˜¾ç¤ºå½“æ—¥ç¬¬ä¸€æ¡ä½™é¢è®°å½•
- **å…¶ä»–æ—¶é—´ä½™é¢**ï¼šæ˜¾ç¤ºè¯¥æ—¶é—´æ®µæœ€åä¸€æ¡ä½™é¢è®°å½•
- **ç”¨ç”µé‡è®¡ç®—**ï¼šå‡†ç¡®è®¡ç®—å„æ—¶é—´æ®µçš„ç”¨ç”µæ¶ˆè€—
- **å……å€¼è¯†åˆ«**ï¼šè‡ªåŠ¨è¯†åˆ«å¹¶æ’é™¤å……å€¼å¯¹ç”¨ç”µç»Ÿè®¡çš„å½±å“
- **æ•°æ®ä¿®å¤**ï¼šä¿®å¤0ç‚¹è¿›å…¥é¡µé¢æ— æ³•æ­£ç¡®åˆ·æ–°å½“æ—¥æ•°æ®çš„é—®é¢˜
- **å†å²è®°å½•ä¼˜åŒ–**ï¼šä¿®å¤å……å€¼åå†å²è®°å½•å½“æ—¥ç”¨ç”µæ˜¾ç¤ºä¸º0çš„æƒ…å†µ

### å“åº”å¼è®¾è®¡
- **ç§»åŠ¨ç«¯ä¼˜å…ˆ**ï¼šé’ˆå¯¹æ‰‹æœºæµè§ˆå™¨ä¼˜åŒ–
- **å›¾è¡¨äº¤äº’**ï¼šæ”¯æŒç¼©æ”¾ã€æ»‘åŠ¨æŸ¥çœ‹å†å²æ•°æ®
- **å®æ—¶æ›´æ–°**ï¼šåå°å®šæ—¶æŠ“å–ï¼Œå‰ç«¯å¯æ‰‹åŠ¨åˆ·æ–°

### æ—¶é—´ç»´åº¦æ”¯æŒ
- **æ—¥è§†å›¾**ï¼š24å°æ—¶è¶‹åŠ¿ï¼Œæ”¯æŒé€‰æ‹©ä»»æ„å†å²æ—¥æœŸ
- **å‘¨è§†å›¾**ï¼šè¿‘7å¤©è¶‹åŠ¿å¯¹æ¯”
- **æœˆè§†å›¾**ï¼šè¿‘30å¤©è¶‹åŠ¿åˆ†æ

## ğŸ“ˆ è®¡ç®—é€»è¾‘

### å½“æ—¥ç”¨ç”µï¼ˆKPIï¼‰
- **ä»Šæ—¥é€‰æ‹©**ï¼šå½“æ—¥ç¬¬ä¸€æ¡ä½™é¢ âˆ’ å½“æ—¥æœ€åä¸€æ¡ä½™é¢
- **å†å²æ—¥æœŸ**ï¼šè¯¥æ—¥æœŸé¦–å°¾ä½™é¢å·®å€¼

### å°æ—¶è¶‹åŠ¿ï¼ˆä»Šå¤©è§†å›¾ï¼‰
- **æ¯å°æ—¶ä½™é¢**ï¼š00ç‚¹å–ç¬¬ä¸€æ¡ï¼Œå…¶ä»–å°æ—¶å–æœ€åä¸€æ¡
- **æ¯å°æ—¶ç”¨ç”µ**ï¼šä¸Šä¸€å°æ—¶ä½™é¢ âˆ’ å½“å‰å°æ—¶ä½™é¢

### å¤©è¶‹åŠ¿ï¼ˆè¿‘7å¤©/è¿‘30å¤©ï¼‰
- **æ¯å¤©ä½™é¢**ï¼šå½“å¤©æœ€åä¸€æ¡ä½™é¢
- **æ¯å¤©ç”¨ç”µ**ï¼šåŒä¸€å¤©å†…ç›¸é‚»è¯»æ•°çš„ä¸‹é™é‡ç´¯åŠ 

### å‘¨æœŸå¯¹æ¯”
- **ä»Šæ—¥vsæ˜¨æ—¥**ï¼šä½¿ç”¨ `/kpi` æ¥å£ï¼Œæ”¯æŒå……å€¼è¯†åˆ«
- **æœ¬å‘¨æœŸvsä¸Šå‘¨æœŸ**ï¼šä½¿ç”¨ `/period_kpi` æ¥å£å¯¹æ¯”æ€»ç”¨ç”µé‡

## ğŸ”„ è‡ªåŠ¨åŒ–ç‰¹æ€§

### CI/CD æµç¨‹
- **ä»£ç æ¨é€** â†’ GitHub Actions è‡ªåŠ¨æ„å»ºé•œåƒ
- **æœåŠ¡æ›´æ–°** â†’ è¿è¡Œ `./update.sh` æ›´æ–°éƒ¨ç½²
- **å®¹å™¨ç›‘æ§** â†’ Watchtower ç›‘æ§å®¹å™¨çŠ¶æ€

### å®šæ—¶ä»»åŠ¡
- **æ•°æ®æŠ“å–**ï¼šæ¯5åˆ†é’Ÿè‡ªåŠ¨æŠ“å–ç”µè¡¨æ•°æ®
- **å¯åŠ¨ä¿æŠ¤**ï¼šæœåŠ¡å¯åŠ¨æ—¶ç«‹å³æŠ“å–ä¸€æ¬¡æ•°æ®
- **æ¯æ—¥æŠ¥å‘Š**ï¼šæ¯å¤©ä¸Šåˆ9ç‚¹è‡ªåŠ¨å‘é€ç”¨ç”µæŠ¥å‘Šè‡³å¾®ä¿¡ï¼ˆéœ€é…ç½®Serveré…±ï¼‰

## ğŸ“± å¾®ä¿¡é€šçŸ¥é…ç½®

æœ¬ç³»ç»Ÿæ”¯æŒé€šè¿‡Serveré…±å‘é€æ¯æ—¥ç”¨ç”µæŠ¥å‘Šè‡³å¾®ä¿¡ï¼Œè®©æ‚¨éšæ—¶æŒæ¡ç”¨ç”µæƒ…å†µã€‚

### 1. è·å–Serveré…±SendKey

1. è®¿é—® [Serveré…±å®˜ç½‘](https://sct.ftqq.com/)
2. ä½¿ç”¨å¾®ä¿¡æ‰«ç ç™»å½•
3. å¤åˆ¶æ‚¨çš„SendKey

### 2. é…ç½®ç¯å¢ƒå˜é‡

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š
```bash
SERVER_CHAN_KEY_1=your-send-key-here  # è®¾å¤‡1çš„SendKey
SERVER_CHAN_KEY_2=your-send-key-here  # è®¾å¤‡2çš„SendKeyï¼ˆå¦‚æœ‰å¤šè®¾å¤‡ï¼‰
```

### 3. é€šçŸ¥åŠŸèƒ½è¯´æ˜

- **è‡ªåŠ¨å‘é€æ—¶é—´**ï¼šæ¯å¤©ä¸Šåˆ9:00
- **é€šçŸ¥å†…å®¹**ï¼šè®¾å¤‡åç§°ã€æ˜¨æ—¥ç”¨ç”µé‡ã€æœŸåˆ/æœŸæœ«ä½™é¢ã€ç”¨ç”µåˆ†æ
- **æ™ºèƒ½å›¾æ ‡**ï¼šæ ¹æ®ç”¨ç”µé‡è‡ªåŠ¨æ˜¾ç¤ºä¸åŒå›¾æ ‡
  - ğŸ”¥ ç”¨ç”µé‡ > 10åº¦ï¼šç”¨ç”µè¾ƒå¤š
  - âš¡ ç”¨ç”µé‡ 5-10åº¦ï¼šæ­£å¸¸ç”¨ç”µ
  - ğŸ’¡ ç”¨ç”µé‡ 0-5åº¦ï¼šç”¨ç”µè¾ƒå°‘
  - ğŸ’¤ ç”¨ç”µé‡ â‰ˆ 0åº¦ï¼šå‡ ä¹æ— ç”¨ç”µ

### 4. æµ‹è¯•é€šçŸ¥

è®¿é—®æµ‹è¯•æ¥å£éªŒè¯é…ç½®ï¼š
```bash
curl "http://your-server:9136/test_notification?device_id=19101109825"
```

### 5. æ•…éšœæ’æŸ¥

- **é€šçŸ¥æœªæ”¶åˆ°**ï¼šæ£€æŸ¥SendKeyæ˜¯å¦æ­£ç¡®é…ç½®
- **å‘é€å¤±è´¥**ï¼šæŸ¥çœ‹ç³»ç»Ÿæ—¥å¿— `./deploy.sh logs`
- **æ•°æ®å¼‚å¸¸**ï¼šé€šè¿‡ `/test_notification` æ¥å£æ£€æŸ¥æŠ¥å‘Šå†…å®¹

## ğŸ“‹ è®¾å¤‡é…ç½®

åœ¨ `main.py` ä¸­é…ç½®ç›‘æ§è®¾å¤‡ï¼š
```python
DEVICE_LIST = [
    {"id": "19101109825", "name": "è®¾å¤‡1"},
    {"id": "19104791678", "name": "è®¾å¤‡2"},
]
```

## ğŸ” æ•…éšœæ’æŸ¥

### æœåŠ¡æ— æ³•å¯åŠ¨
```bash
./deploy.sh logs  # æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker ps         # æ£€æŸ¥å®¹å™¨çŠ¶æ€
```

### æ•°æ®åº“è¿æ¥é—®é¢˜
```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
docker exec electricity-bill python -c "import pymysql; print('æ•°æ®åº“è¿æ¥æµ‹è¯•')"
```

### ç«¯å£å†²çª
```bash
netstat -tlnp | grep 9136  # æ£€æŸ¥ç«¯å£å ç”¨
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
electricityBill/
â”œâ”€â”€ main.py              # ä¸»åº”ç”¨ç¨‹åº
â”œâ”€â”€ requirements.txt     # Python ä¾èµ–
â”œâ”€â”€ Dockerfile          # Docker é•œåƒæ„å»º
â”œâ”€â”€ docker-compose.yml  # Docker ç¼–æ’é…ç½®
â”œâ”€â”€ deploy.sh           # éƒ¨ç½²ç®¡ç†è„šæœ¬
â”œâ”€â”€ update.sh           # æ›´æ–°è„šæœ¬
â”œâ”€â”€ env.example         # ç¯å¢ƒé…ç½®æ¨¡æ¿
â”œâ”€â”€ .env               # ç¯å¢ƒé…ç½®æ–‡ä»¶ï¼ˆéœ€åˆ›å»ºï¼‰
â”œâ”€â”€ templates/         # å‰ç«¯æ¨¡æ¿
â”‚   â””â”€â”€ index.html     # ä¸»é¡µé¢
â””â”€â”€ .github/workflows/ # GitHub Actions
    â””â”€â”€ docker-build.yml
```

## ğŸš€ åœ¨å…¶ä»–æœºå™¨éƒ¨ç½²

```bash
# æ–¹æ³•ä¸€ï¼šGit å…‹éš†
git clone https://github.com/jinbao55/electricitybill.git
cd electricitybill
cp env.example .env && nano .env
./deploy.sh start

# æ–¹æ³•äºŒï¼šæ›´æ–°ç°æœ‰éƒ¨ç½²
./update.sh
```

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### æœ¬åœ°å¼€å‘ç¯å¢ƒ
```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv .venv
source .venv/bin/activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# é…ç½®ç¯å¢ƒå˜é‡
cp env.example .env && nano .env

# è¿è¡Œå¼€å‘æœåŠ¡å™¨
python main.py
```


## ğŸ“ API æ¥å£

- `GET /` - å‰ç«¯é¡µé¢
- `GET /data?period=day|week|month&device_id=ID&date=YYYY-MM-DD` - è·å–è¶‹åŠ¿æ•°æ®
- `GET /kpi?device_id=ID` - è·å–KPIæ•°æ®ï¼ˆä½™é¢ã€å½“æ—¥/æ˜¨æ—¥ç”¨ç”µï¼‰
- `GET /period_kpi?period=week|month&device_id=ID` - è·å–å‘¨æœŸå¯¹æ¯”æ•°æ®
- `GET /fetch?device_id=ID` - æ‰‹åŠ¨è§¦å‘æ•°æ®æŠ“å–
- `GET /recharge_history?device_id=ID&days=30&limit=50` - è·å–å……å€¼å†å²è®°å½•
- `GET /test_notification?device_id=ID` - æµ‹è¯•å¾®ä¿¡é€šçŸ¥åŠŸèƒ½

## ğŸ”’ å®‰å…¨å»ºè®®

- é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®æ•æ„Ÿä¿¡æ¯ï¼Œé¿å…ç¡¬ç¼–ç 
- å®šæœŸå¤‡ä»½æ•°æ®åº“æ•°æ®
- è®¾ç½®é€‚å½“çš„æŠ“å–é¢‘ç‡ï¼Œé¿å…å¯¹æ•°æ®æºé€ æˆå‹åŠ›
- ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨åå‘ä»£ç†ï¼ˆNginxï¼‰

## ğŸ“ æŠ€æœ¯æ”¯æŒ

- æŸ¥çœ‹æ—¥å¿—ï¼š`./deploy.sh logs`
- æ£€æŸ¥çŠ¶æ€ï¼š`./deploy.sh status`
- é‡å¯æœåŠ¡ï¼š`./deploy.sh restart`

---

## è®¸å¯è¯

ä»…ç”¨äºä¸ªäººå­¦ä¹ ä¸ä½¿ç”¨åœºæ™¯ã€‚