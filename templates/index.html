<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>电表统计</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<style>
:root{
  --bg:#f7f8fa;--card:#fff;--text:#111;--muted:#6b7280;--primary:#0ea5e9;--accent:#ef4444;
}
*{box-sizing:border-box}
html,body{height:100%}
body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
.header{position:sticky;top:0;background:var(--bg);padding:10px 12px;z-index:10}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
select,button{appearance:none;border:1px solid #e5e7eb;background:var(--card);padding:8px 10px;border-radius:10px;font-size:15px}
button{color:var(--text);background:var(--card);border:1px solid #e5e7eb}
.period-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.primary{background:var(--primary);color:#fff;border:none}
.container{padding:12px}
.section{margin-bottom:14px}
.card{background:var(--card);border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:10px}
.chart-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
.chart-inner{min-width:600px}
.title{margin:6px 0 8px 4px;font-size:18px;color:var(--muted)}
canvas{width:100% !important;height:300px !important}
@media(min-width:768px){canvas{height:360px !important}}
.status{margin:8px 4px;color:var(--muted)}
.range{margin:6px 4px;color:var(--muted);font-size:13px}
/* KPI cards */
.kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
@media(min-width:768px){.kpis{grid-template-columns:repeat(4,1fr)}}
.kpi{background:var(--card);border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:10px}
.kpi .label{font-size:13px;color:var(--muted)}
.kpi .value{font-size:20px;font-weight:600;margin-top:6px}
.kpi .sub{font-size:12px;color:var(--muted);margin-top:4px}
.up{color:#16a34a}
.down{color:#ef4444}
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>
<div class="header">
  <div class="toolbar">
    <select id="deviceSelect" onchange="loadData(currentPeriod)"></select>
    <button class="period-btn" id="dateBtn" onclick="openDatePicker()">日期</button>
    <input type="date" id="datePicker" class="sr-only" onchange="onDateChange(this.value)" oninput="onDateChange(this.value)" />
    <button class="period-btn" data-period="week" onclick="loadData('week')">近7天</button>
    <button class="period-btn" data-period="month" onclick="loadData('month')">近30天</button>
    <button onclick="fetchData()">抓取</button>
  </div>
</div>
<div class="container">
  <p id="rangeIndicator" class="range"></p>
  <div class="kpis">
    <div class="kpi">
      <div class="label">当前余额</div>
      <div class="value" id="kpi-balance">--</div>
      <div class="sub">单位：元</div>
    </div>
    <div class="kpi">
      <div class="label" id="kpi-usage-label">今日用电</div>
      <div class="value" id="kpi-today">--</div>
      <div class="sub">单位：度</div>
    </div>
    <div class="kpi">
      <div class="label" id="kpi-compare-label">较昨日</div>
      <div class="value" id="kpi-compare">--</div>
      <div class="sub" id="kpi-compare-sub"></div>
    </div>
    <div class="kpi">
      <div class="label">预计可用天数</div>
      <div class="value" id="kpi-days">--</div>
      <div class="sub">基于近7天日均</div>
    </div>
  </div>
  <div class="section">
    <div class="title">用电量趋势</div>
    <div class="card">
      <div class="chart-scroll" id="balanceScroll">
        <div class="chart-inner" id="balanceChartInner">
          <canvas id="balanceLineChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  <div class="section">
    <div class="title">余额</div>
    <div class="card">
      <div class="chart-scroll" id="usageScroll">
        <div class="chart-inner" id="usageChartInner">
          <canvas id="usageBarChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  <p id="status" class="status"></p>
</div>
<script>
let devices = [];
const isMobile = window.matchMedia('(max-width: 768px)').matches;
let usageLineChart, balanceBarChart;
let currentPeriod = 'day';
let currentDate = new Date().toISOString().slice(0,10);

function populateDevices(){
  const sel = document.getElementById('deviceSelect');
  sel.innerHTML = devices.map(d=>`<option value="${d.id}">${d.name}</option>`).join('');
}
function onDateChange(v){
  currentPeriod = 'day';
  // 如果选择与当前相同日期，也应触发刷新（处理某些浏览器只触发 change 的问题）
  const todayStr = new Date().toISOString().slice(0,10);
  currentDate = v || todayStr;
  const dp = document.getElementById('datePicker');
  if(!v){ dp.value = todayStr; }
  // 日期模式下清除按钮高亮
  document.querySelectorAll('.period-btn').forEach(btn=>btn.classList.remove('active'));
  // 强制刷新
  loadData('day');
}

function openDatePicker(){
  const dp = document.getElementById('datePicker');
  // 默认今天
  if(!dp.value) dp.value = new Date().toISOString().slice(0,10);
  dp.showPicker ? dp.showPicker() : dp.click();
}

const commonOptions = {
  responsive:true,
  maintainAspectRatio:false,
  layout:{padding:{top:16,right:8,bottom:0,left:8}},
  interaction:{mode:'index',intersect:false},
  plugins:{
    legend:{display:false},
    tooltip:{
      enabled:true,
      callbacks:{label:(ctx)=>`${ctx.dataset.label}: ${Number(ctx.parsed.y??ctx.raw).toFixed(2)}`},
      bodyFont:{size:isMobile?12:13},
      titleFont:{size:isMobile?12:13}
    },
    datalabels:{
      display:(ctx)=>{
        // 仅在移动端显示每隔N个柱的标签，避免重叠
        const idx = ctx.dataIndex || 0;
        const total = ctx.chart.data.labels?.length || 0;
        const step = total>20 ? 5 : total>12 ? 3 : 2;
        return (idx % step)===0;
      },
      formatter:(v)=>Number(v).toFixed(2),
      color:'#111',
      backgroundColor:'rgba(255,255,255,0.85)',
      borderRadius:6,
      padding:{top:2,right:4,bottom:2,left:4},
      anchor:'end',align:'end',offset:-2,clamp:true
    }
  },
  scales:{
    y:{beginAtZero:true,grid:{color:'rgba(0,0,0,0.06)'},ticks:{callback:(v)=>Number(v).toFixed(2),font:{size:isMobile?11:12}}},
    x:{grid:{display:false},ticks:{maxRotation:0,autoSkip:true,autoSkipPadding:8,maxTicksLimit:isMobile?6:12,font:{size:isMobile?10:12}}}
  }
};

function renderSeparatedCharts(labels, balances, usage){
  const perPoint = isMobile ? 36 : 24;
  // 用电量折线（上）
  const inner1 = document.getElementById('balanceChartInner');
  inner1.style.width = Math.max(inner1.clientWidth, labels.length * perPoint + 80) + 'px';
  const ctx1 = document.getElementById('balanceLineChart').getContext('2d');
  if(usageLineChart) usageLineChart.destroy();
  usageLineChart = new Chart(ctx1, {
    type:'line',
    data:{ labels, datasets:[{ label:'用电量', data:usage, borderColor:'rgba(239,68,68,1)', backgroundColor:'rgba(239,68,68,0.15)', tension:0.25, fill:true, pointRadius:0, borderWidth:2 }] },
    options:{
      ...commonOptions,
      plugins:{
        ...commonOptions.plugins,
        datalabels:{
          ...commonOptions.plugins.datalabels,
          display:true,
          align:'top',
          anchor:'end',
          offset:2,
          formatter:(v)=>Number(v).toFixed(2)
        }
      },
      scales:{ y:{ beginAtZero:true, ticks:{ callback:(v)=>Number(v).toFixed(2) } }, x:{ ...commonOptions.scales.x, ticks:{ ...commonOptions.scales.x.ticks, autoSkip:false } } }
    },
    plugins:[ChartDataLabels]
  });

  // 余额柱状（下）
  const inner2 = document.getElementById('usageChartInner');
  inner2.style.width = Math.max(inner2.clientWidth, labels.length * perPoint + 80) + 'px';
  const ctx2 = document.getElementById('usageBarChart').getContext('2d');
  if(balanceBarChart) balanceBarChart.destroy();
  balanceBarChart = new Chart(ctx2, {
    type:'bar',
    data:{ labels, datasets:[{ label:'余额', data:balances, backgroundColor:'rgba(14,165,233,0.65)', borderColor:'rgba(14,165,233,1)', borderWidth:1, borderRadius:6, maxBarThickness:isMobile?18:32, categoryPercentage:0.5, barPercentage:0.8 }] },
    options:{ ...commonOptions, plugins:{ ...commonOptions.plugins, datalabels:{ ...commonOptions.plugins.datalabels, display:true, formatter:(v)=>Number(v).toFixed(2) } }, scales:{ y:{ beginAtZero:true, ticks:{ callback:(v)=>Number(v).toFixed(2) } }, x:{ ...commonOptions.scales.x, ticks:{ ...commonOptions.scales.x.ticks, autoSkip:false } } } },
    plugins:[ChartDataLabels]
  });
}

function updateKpis(dayData, weekData){
  const fmt = (n)=>Number(n??0).toFixed(2);
  // 通过后端 /kpi 获取所需基准数据
  const deviceId = document.getElementById('deviceSelect').value;
  fetch(`/kpi?device_id=${deviceId}`).then(r=>r.json()).then(k=>{
    const currentBalance = Number(k.current_balance ?? 0);
    const todayUsage = Number(k.usage_today ?? 0);
    const yesterdayUsage = Number(k.usage_yesterday ?? 0);
    const rechargeToday = Number(k.recharge_today ?? 0);

    // 当前余额 = 当前剩余电量（1 元 = 1 度电）
    document.getElementById('kpi-balance').textContent = fmt(currentBalance);
    // 今日用电（充值感知后）
    document.getElementById('kpi-today').textContent = fmt(todayUsage);

    // 较昨日/较上周期
    const diffEl = document.getElementById('kpi-compare');
    const diffSub = document.getElementById('kpi-compare-sub');
    let diff = todayUsage - yesterdayUsage;
    let subText = `昨日 ${fmt(yesterdayUsage)}，今日 ${fmt(todayUsage)}${rechargeToday>0?`，充值 ${fmt(rechargeToday)}`:''}`;
    // 周/月改为“较上周期”，以接口 /period_kpi 计算
    if(currentPeriod !== 'day'){
      const deviceId = document.getElementById('deviceSelect').value;
      fetch(`/period_kpi?period=${currentPeriod}&device_id=${deviceId}`).then(r=>r.json()).then(pk=>{
        const cu = Number(pk.current_usage||0), pu = Number(pk.previous_usage||0);
        const d = cu - pu;
        diffEl.textContent = `${d>=0?'+':''}${fmt(d)}`;
        diffEl.className = 'value ' + (d>=0? 'up':'down');
        diffSub.textContent = `上周期 ${fmt(pu)}，本周期 ${fmt(cu)}`;
      });
    } else {
      diffEl.textContent = `${diff>=0?'+':''}${fmt(diff)}`;
      diffEl.className = 'value ' + (diff>=0? 'up':'down');
      diffSub.textContent = subText;
    }

    // 预计可用天数：以最近 7 天日均用电估算（仍保留原逻辑）
    const labelsW = weekData.labels||[]; const usageW = weekData.usage||[];
    const todayStr = new Date().toISOString().slice(0,10);
    const todayIdx = labelsW.indexOf(todayStr);
    const usageForAvg = usageW.filter((_,i)=> i>0 && i!==todayIdx).map(Number).filter(v=>v>0);
    const avg7 = usageForAvg.length ? (usageForAvg.reduce((a,b)=>a+b,0)/usageForAvg.length) : 0;
    const days = avg7>0 ? (currentBalance/avg7) : Infinity;
    document.getElementById('kpi-days').textContent = isFinite(days) ? fmt(days) : '∞';
  });
}

function loadData(period){
  currentPeriod = period;
  // 高亮当前周期按钮
  document.querySelectorAll('.period-btn').forEach(btn=>{
    if(btn.dataset.period === period){ btn.classList.add('active'); }
    else { btn.classList.remove('active'); }
  });
  const deviceId = document.getElementById('deviceSelect').value;
  Promise.all([
    fetch(`/data?period=${period}&device_id=${deviceId}${period==='day' ? `&date=${encodeURIComponent(currentDate)}`:''}`).then(r=>r.json()),
    fetch(`/data?period=day&device_id=${deviceId}`).then(r=>r.json()),
    fetch(`/data?period=week&device_id=${deviceId}`).then(r=>r.json())
  ]).then(([chartRes, dayRes, weekRes])=>{
    if(chartRes.labels.length===0) document.getElementById('status').innerText='暂无数据，先抓取或稍后再试';
    renderSeparatedCharts(chartRes.labels, chartRes.balances, chartRes.usage);
    // 显示当前选择的日期/时间段
    const rangeEl = document.getElementById('rangeIndicator');
    if(period==='day'){
      rangeEl.textContent = `当前日期：${currentDate}`;
    } else if(period==='week'){
      const end = new Date();
      const start = new Date(); start.setDate(end.getDate()-6);
      rangeEl.textContent = `时间段：${start.toISOString().slice(0,10)} ~ ${end.toISOString().slice(0,10)}`;
    } else {
      const end = new Date();
      const start = new Date(); start.setDate(end.getDate()-29);
      rangeEl.textContent = `时间段：${start.toISOString().slice(0,10)} ~ ${end.toISOString().slice(0,10)}`;
    }
    updateKpis(dayRes, weekRes);
    // 更新用电/对比标签文案
    const labelEl = document.getElementById('kpi-usage-label');
    labelEl.textContent = period==='day' ? '当日用电' : (period==='week' ? '近7天用电' : '近30天用电');
    const compareLabel = document.getElementById('kpi-compare-label');
    compareLabel.textContent = period==='day' ? '较昨日' : '较上周期';
    // 更新 KPI 数值
    if(period==='day'){
      const arr = dayRes.balances||[];
      const valid = arr.filter(v => v!==null && v!==undefined && !isNaN(Number(v)));
      const first = valid.length ? Number(valid[0]) : null;
      const last = valid.length ? Number(valid[valid.length-1]) : null;
      const todayUsage = (first!=null && last!=null) ? Math.max(Number(first) - Number(last), 0) : 0;
      document.getElementById('kpi-today').textContent = todayUsage.toFixed(2);
    } else {
      const totalUsage = (chartRes.usage||[]).reduce((a,b)=>a+Number(b||0),0);
      document.getElementById('kpi-today').textContent = Number(totalUsage).toFixed(2);
    }
  });
}

function fetchData(){
  const deviceId = document.getElementById('deviceSelect').value;
  document.getElementById('status').innerText='抓取中...';
  fetch(`/fetch?device_id=${deviceId}`).then(r=>r.json()).then(res=>{
    document.getElementById('status').innerText=res.message;loadData(currentPeriod);
  });
}

document.addEventListener('DOMContentLoaded',()=>{
  const el = document.getElementById('devices-json');
  try { devices = JSON.parse(el ? el.textContent : '[]'); } catch(e) { devices = []; }
  populateDevices();
  loadData('day');
});
</script>
<script type="application/json" id="devices-json">{{ devices|tojson }}</script>
</body>
</html>