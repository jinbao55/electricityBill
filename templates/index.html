<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>ç”µè¡¨ç»Ÿè®¡</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<style>
:root{
  --bg:#f7f8fa;--card:#fff;--text:#111;--muted:#6b7280;--primary:#0ea5e9;--accent:#ef4444;
}
*{box-sizing:border-box}
html,body{height:100%}
body { font-family: sans-serif; margin:0; background:#f9f9f9; color:#111; }
header {
  padding:10px;
  background: linear-gradient(90deg, #4a90e2, #357ab8);
  color:#fff;
  display:flex;
  align-items:center;
  flex-wrap:wrap;
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
}

header select,
header input {
  margin-left:10px;
  padding:6px 10px;
  border-radius:6px;
  border:none;
  background:#fff;
  color:#333;
  box-shadow:0 1px 3px rgba(0,0,0,0.1);
  font-size:14px;
  transition: all 0.2s ease;
}
header select:focus,
header input:focus {
  outline:none;
  box-shadow:0 0 0 2px rgba(74,144,226,0.4);
}

.toolbar {
  display:flex;
  gap:10px;
  margin-left:auto;
  flex-wrap:wrap;
}

.period-btn {
  padding:6px 14px;
  border:none;
  border-radius:20px;
  cursor:pointer;
  background:#fff;
  color:#4a90e2;
  font-size:14px;
  font-weight:500;
  box-shadow:0 1px 3px rgba(0,0,0,0.1);
  transition: all 0.25s ease;
}
.period-btn:hover {
  background:#f0f4fa;
}

button {
  cursor:pointer;
}

/* æŠ“å–æŒ‰é’®å•ç‹¬æ ·å¼ */
.fetch-btn {
  padding:6px 18px;
  border:none;
  border-radius:20px;
  cursor:pointer;
  background:#ff9800;   /* æ©™è‰²ä¸»æŒ‰é’® */
  color:#fff;
  font-size:14px;
  font-weight:600;
  box-shadow:0 2px 6px rgba(0,0,0,0.2);
  transition: all 0.25s ease;
}
.fetch-btn:hover {
  background:#e68900;
  transform:scale(1.05);
}

.period-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}

.primary{background:var(--primary);color:#fff;border:none}
.container{padding:12px}
.section{margin-bottom:14px}
.card{background:var(--card);border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:10px}
.chart-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
.chart-inner{min-width:600px}
.title{margin:6px 0 8px 4px;font-size:18px;color:var(--muted)}
canvas{width:100% !important;height:300px !important}
@media(min-width:768px){canvas{height:360px !important}}
.status{margin:8px 4px;color:var(--muted)}
.range{margin:6px 4px;color:var(--muted);font-size:13px}
/* KPI cards */
.kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
@media(min-width:768px){.kpis{grid-template-columns:repeat(4,1fr)}}
.kpi{background:var(--card);border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:10px}
.kpi .label{font-size:13px;color:var(--muted)}
.kpi .value{font-size:20px;font-weight:600;margin-top:6px}
.kpi .sub{font-size:12px;color:var(--muted);margin-top:4px}
.up{color:#16a34a}
.down{color:#ef4444}
/* æ‰‹æœºç«¯ header å“åº”å¼ */
@media(max-width:768px){
  header {
    flex-direction: column;
    align-items: stretch;
    padding: 10px 8px; /* å¢åŠ å·¦å³ padding */
    gap: 6px; /* header å†…å…ƒç´ ä¸Šä¸‹é—´è· */
  }

  header span {
    font-size: 16px;
    margin-bottom: 6px;
  }

  .header-row {
    display: flex;
    gap: 6px;
    width: 100%;
  }

  .header-row select,
  .header-row input {
    flex: 1;
    min-width: 0;
    padding: 6px 8px; /* å‡å°é«˜åº¦ï¼Œé¿å…æ‹¥æŒ¤ */
    font-size: 14px;
  }

  .toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    width: 100%;
    margin-top: 4px; /* æŒ‰é’®è¡Œä¸ä¸Šæ–¹é—´è· */
  }

  .toolbar button {
    flex: 1 1 auto;
    min-width: 80px;
    padding: 6px 0; /* å‡å°‘æŒ‰é’®é«˜åº¦ */
    font-size: 14px;
  }
}

/* å……å€¼å†å²æ ·å¼ */
.recharge-history {
  display: none;
}

.recharge-history.active {
  display: block;
}

.recharge-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  flex-wrap: wrap;
  gap: 8px;
}

.recharge-filter {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}

.recharge-filter select {
  padding: 6px 10px;
  border: 1px solid #ddd;
  border-radius: 6px;
  background: #fff;
  font-size: 14px;
}

.recharge-summary {
  font-size: 14px;
  color: var(--muted);
}

.recharge-list {
  max-height: 400px;
  overflow-y: auto;
}

.recharge-item {
  background: var(--card);
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
  padding: 12px;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.2s ease;
}

.recharge-item:hover {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.recharge-info {
  flex: 1;
}

.recharge-date {
  font-weight: 600;
  color: var(--text);
  margin-bottom: 2px;
}

.recharge-time {
  font-size: 12px;
  color: var(--muted);
}

.recharge-amount {
  text-align: right;
}

.recharge-money {
  font-size: 18px;
  font-weight: 600;
  color: #16a34a;
  margin-bottom: 2px;
}

.recharge-balance {
  font-size: 12px;
  color: var(--muted);
}

.no-recharge {
  text-align: center;
  padding: 40px 20px;
  color: var(--muted);
  font-size: 16px;
}

@media(max-width:768px){
  .recharge-controls {
    flex-direction: column;
    align-items: stretch;
  }
  
  .recharge-filter {
    justify-content: space-between;
  }
  
  .recharge-item {
    padding: 10px;
  }
  
  .recharge-money {
    font-size: 16px;
  }
}

</style>
</head>
<body>

<header>
  <span>ç”µè¡¨å¯è§†åŒ–</span>
  <div class="header-row">
    <select id="deviceSelect" onchange="loadData(currentPeriod)"></select>
    <input type="text" id="datePicker" placeholder="é€‰æ‹©æ—¥æœŸ">
  </div>
  <div class="toolbar">
    <button class="period-btn" id="todayBtn" data-period="day" onclick="showToday()">ä»Šæ—¥</button>
    <button class="period-btn" data-period="week" onclick="loadData('week')">è¿‘7å¤©</button>
    <button class="period-btn" data-period="month" onclick="loadData('month')">è¿‘30å¤©</button>
    <button class="period-btn" id="rechargeBtn" onclick="showRechargeHistory()">å……å€¼å†å²</button>
    <button class="fetch-btn" onclick="fetchData()">æŠ“å–</button>

  </div>
</header>

<div class="container">
  <p id="rangeIndicator" class="range"></p>
  
  <!-- åŸæœ‰çš„ç»Ÿè®¡ç•Œé¢ -->
  <div id="statisticsView">
    <div class="kpis">
      <div class="kpi">
        <div class="label">å½“å‰ä½™é¢</div>
        <div class="value" id="kpi-balance">--</div>
        <div class="sub">å•ä½ï¼šå…ƒ</div>
      </div>
      <div class="kpi">
        <div class="label" id="kpi-usage-label">ä»Šæ—¥ç”¨ç”µ</div>
        <div class="value" id="kpi-today">--</div>
        <div class="sub">å•ä½ï¼šåº¦</div>
      </div>
      <div class="kpi">
        <div class="label" id="kpi-compare-label">è¾ƒæ˜¨æ—¥</div>
        <div class="value" id="kpi-compare">--</div>
        <div class="sub" id="kpi-compare-sub"></div>
      </div>
      <div class="kpi">
        <div class="label">é¢„è®¡å¯ç”¨å¤©æ•°</div>
        <div class="value" id="kpi-days">--</div>
        <div class="sub">åŸºäºè¿‘7å¤©æ—¥å‡</div>
      </div>
    </div>
    <div class="section">
      <div class="title">ç”¨ç”µé‡è¶‹åŠ¿</div>
      <div class="card">
        <div class="chart-scroll" id="balanceScroll">
          <div class="chart-inner" id="balanceChartInner">
            <canvas id="balanceLineChart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="section">
      <div class="title">ä½™é¢</div>
      <div class="card">
        <div class="chart-scroll" id="usageScroll">
          <div class="chart-inner" id="usageChartInner">
            <canvas id="usageBarChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- å……å€¼å†å²ç•Œé¢ -->
  <div id="rechargeHistoryView" class="recharge-history">
    <div class="section">
      <div class="title">ğŸ’° å……å€¼å†å²</div>
      <div class="card">
        <div class="recharge-controls">
          <div class="recharge-filter">
            <select id="rechargeDays">
              <option value="7">è¿‘7å¤©</option>
              <option value="30" selected>è¿‘30å¤©</option>
              <option value="90">è¿‘90å¤©</option>
            </select>
            <button class="period-btn" onclick="loadRechargeHistory()">åˆ·æ–°</button>
          </div>
          <div class="recharge-summary" id="rechargeSummary">
            --
          </div>
        </div>
        <div class="recharge-list" id="rechargeList">
          <div class="no-recharge">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>
  </div>
  
  <p id="status" class="status"></p>
</div>

<script>
/* å…¨å±€å˜é‡ */
let devices = [];
const isMobile = window.matchMedia('(max-width: 768px)').matches;
let usageLineChart = null, balanceBarChart = null;
let currentPeriod = 'day';
let currentDate = getTodayInChina(); // ä½¿ç”¨ä¸­å›½æ—¶åŒºçš„ä»Šæ—¥
let datePicker = null;

/* æ³¨å†Œ ChartDataLabelsï¼ˆå¦‚æœè¢«åŠ è½½ï¼‰ */
if (window.Chart && window.ChartDataLabels) {
  Chart.register(ChartDataLabels);
}

/* å°å·¥å…·ï¼šå®‰å…¨æ ¼å¼åŒ–æ•°å­— */
function fmt(n){ return Number(n ?? 0).toFixed(2); }

/* è·å–ä¸­å›½æ—¶åŒºçš„ä»Šæ—¥æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆYYYY-MM-DDï¼‰ï¼Œé¿å…UTCæ—¶åŒºé—®é¢˜ */
function getTodayInChina(){
  // è·å–ä¸­å›½æ—¶åŒºï¼ˆUTC+8ï¼‰çš„å½“å‰æ—¥æœŸ
  const now = new Date();
  const chinaTime = new Date(now.getTime() + (8 * 60 * 60 * 1000)); // UTC+8
  const year = chinaTime.getUTCFullYear();
  const month = String(chinaTime.getUTCMonth() + 1).padStart(2, '0');
  const day = String(chinaTime.getUTCDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

/* æ£€æŸ¥å¹¶æ›´æ–°æ—¥æœŸï¼Œè§£å†³è·¨æ—¥é—®é¢˜ */
function checkAndUpdateDate(){
  const newToday = getTodayInChina();
  if(currentDate !== newToday && currentPeriod === 'day'){
    // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯"ä»Šæ—¥"æ¨¡å¼ï¼Œä¸”æ—¥æœŸå·²è·¨æ—¥ï¼Œè‡ªåŠ¨æ›´æ–°
    const todayBtnActive = document.getElementById('todayBtn').classList.contains('active');
    if(todayBtnActive){
      currentDate = newToday;
      if(datePicker){
        datePicker.setDate(currentDate, false);
      }
      // è‡ªåŠ¨åˆ·æ–°æ•°æ®
      loadData('day');
      console.log('Auto-updated to new day:', newToday);
    }
  }
}

/* å®‰å…¨å°†åç«¯çš„ ISO æ—¥æœŸå­—ç¬¦ä¸²è½¬æ¢ä¸º "æœˆ-æ—¥"ï¼ˆé¿å… new Date åœ¨ä¸åŒæµè§ˆå™¨çš„å…¼å®¹é—®é¢˜ï¼‰ */
function shortLabelFromISO(d){
  if(!d) return d;
  if(typeof d !== 'string') d = String(d);
  if(d.includes('-')){
    const parts = d.split('-');
    if(parts.length >= 3){
      return `${Number(parts[1])}-${Number(parts[2])}`;
    }
  }
  // å›é€€è§£æï¼ˆå°½é‡ä¸ä¾èµ–ï¼‰
  const dt = new Date(d);
  if(!isNaN(dt.getTime())){
    return `${dt.getMonth()+1}-${dt.getDate()}`;
  }
  return d;
}

/* æ¸²æŸ“ä¸¤ä¸ªåˆ†å¼€çš„å›¾è¡¨ï¼šç¬¬ä¸€ä¸ªæ˜¯ç”¨ç”µé‡ï¼ˆæŠ˜çº¿ï¼‰ï¼Œç¬¬äºŒä¸ªæ˜¯ä½™é¢ï¼ˆæŸ±/æŠ˜çº¿ï¼‰ */
/* labels: array of 'YYYY-MM-DD'ï¼›balances: arrayï¼›usage: array */
function renderSeparatedCharts(labels = [], balances = [], usage = []){
  // é˜²å¾¡å¼ï¼šç¡®ä¿ä¸ºæ•°ç»„
  labels = Array.isArray(labels) ? labels : [];
  balances = Array.isArray(balances) ? balances : [];
  usage = Array.isArray(usage) ? usage : [];

  // ä»…ç”¨äºæ˜¾ç¤ºçš„çŸ­æ ‡ç­¾ï¼ˆåªæ˜¾ç¤ºæœˆ-æ—¥ï¼‰
  const displayLabels = labels.map(d => shortLabelFromISO(d));

  const perPoint = isMobile ? 36 : 24;
  const inner1 = document.getElementById('balanceChartInner');
  inner1.style.width = Math.max(inner1.clientWidth, displayLabels.length * perPoint + 80) + 'px';
  const ctx1 = document.getElementById('balanceLineChart').getContext('2d');
  if(usageLineChart) usageLineChart.destroy();
  usageLineChart = new Chart(ctx1, {
    type:'line',
    data:{ labels: displayLabels, datasets:[{ label:'ç”¨ç”µé‡', data:usage, borderColor:'rgba(239,68,68,1)', backgroundColor:'rgba(239,68,68,0.15)', tension:0.25, fill:true, pointRadius:0, borderWidth:2 }] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      layout:{padding:{top:16,right:8,bottom:0,left:8}},
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{display:false},
        tooltip:{ enabled:true, callbacks:{label:(ctx)=>`${ctx.dataset.label}: ${Number(ctx.parsed.y??ctx.raw).toFixed(2)}` } },
        datalabels:{
          display: true,
          formatter:(v)=>Number(v).toFixed(2),
          color:'#111',
          backgroundColor:'rgba(255,255,255,0.85)',
          borderRadius:6,
          padding:{top:2,right:4,bottom:2,left:4},
          anchor:'end',align:'end',offset: -2,clamp:true
        }
      },
      scales:{
        y:{ beginAtZero:true, grid:{color:'rgba(0,0,0,0.06)'}, ticks:{callback:(v)=>Number(v).toFixed(2)} },
        x:{ grid:{display:false}, ticks:{ autoSkip:false, maxRotation:0 } }
      }
    },
    plugins: [ ChartDataLabels ]
  });

  const inner2 = document.getElementById('usageChartInner');
  inner2.style.width = Math.max(inner2.clientWidth, displayLabels.length * perPoint + 80) + 'px';
  const ctx2 = document.getElementById('usageBarChart').getContext('2d');
  if(balanceBarChart) balanceBarChart.destroy();
  balanceBarChart = new Chart(ctx2, {
    type:'bar',
    data:{ labels: displayLabels, datasets:[{ label:'ä½™é¢', data:balances, backgroundColor:'rgba(14,165,233,0.65)', borderColor:'rgba(14,165,233,1)', borderWidth:1, borderRadius:6, maxBarThickness:isMobile?18:32, categoryPercentage:0.5, barPercentage:0.8 }] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      layout:{padding:{top:16,right:8,bottom:0,left:8}},
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{display:false},
        tooltip:{ enabled:true, callbacks:{label:(ctx)=>`${ctx.dataset.label}: ${Number(ctx.parsed.y??ctx.raw).toFixed(2)}` } },
        datalabels:{
          display:true,
          formatter:(v)=>Number(v).toFixed(2),
          color:'#111',
          backgroundColor:'rgba(255,255,255,0.85)',
          borderRadius:6,
          padding:{top:2,right:4,bottom:2,left:4},
          anchor:'end',align:'end',offset:-2,clamp:true
        }
      },
      scales:{
        y:{ beginAtZero:true, grid:{color:'rgba(0,0,0,0.06)'}, ticks:{callback:(v)=>Number(v).toFixed(2)} },
        x:{ grid:{display:false}, ticks:{ autoSkip:false, maxRotation:0 } }
      }
    },
    plugins: [ ChartDataLabels ]
  });
}

/* æ›´æ–° KPIï¼šæ ¹æ®å½“å‰å‘¨æœŸåŠ¨æ€æ˜¾ç¤ºå¯¹åº”çš„ç”¨ç”µé‡å’Œå¯¹æ¯”æ•°æ® */
function updateKpis(period, chartData = {}, dayData = {}, weekData = {}){
  const fmtVal = (n)=>Number(n ?? 0).toFixed(2);
  const deviceId = document.getElementById('deviceSelect').value;
  
  // æ„å»º KPI è¯·æ±‚å‚æ•°
  let kpiParams = `device_id=${deviceId}`;
  if(period === 'day'){
    // æ—¥æ¨¡å¼ï¼šå¦‚æœé€‰æ‹©äº†å†å²æ—¥æœŸï¼Œä¼ å…¥ date å‚æ•°
    const todayStr = getTodayInChina(); // ä½¿ç”¨ä¸­å›½æ—¶åŒº
    if(currentDate !== todayStr){
      kpiParams += `&date=${encodeURIComponent(currentDate)}`;
    }
  }
  
  // å¹¶è¡Œè·å–åŸºç¡€æ•°æ®
  Promise.all([
    fetch(`/kpi?${kpiParams}`).then(r=>r.json()).catch(()=>({})),
    period !== 'day' ? fetch(`/period_kpi?period=${period}&device_id=${deviceId}`).then(r=>r.json()).catch(()=>({})) : Promise.resolve({})
  ]).then(([kpiData = {}, periodData = {}])=>{
    const currentBalance = Number(kpiData.current_balance ?? 0);
    
    // æ ¹æ®å‘¨æœŸè®¡ç®—å½“å‰ç”¨ç”µé‡å’Œå¯¹æ¯”æ•°æ®
    let currentUsage = 0;
    let previousUsage = 0;
    let compareText = '';
    let rechargeInfo = '';
    
    if(period === 'day'){
      // æ—¥æ¨¡å¼ï¼šç›´æ¥ä½¿ç”¨åç«¯è®¡ç®—å¥½çš„ç”¨ç”µé‡
      const todayStr = getTodayInChina(); // ä½¿ç”¨ä¸­å›½æ—¶åŒº
      const isToday = currentDate === todayStr;
      
      // ä½¿ç”¨åç«¯è®¡ç®—çš„å‡†ç¡®æ•°æ®ï¼ˆå·²å¤„ç†å……å€¼æƒ…å†µï¼‰
      currentUsage = Number(kpiData.usage_today ?? kpiData.usage_target ?? 0);
      previousUsage = Number(kpiData.usage_yesterday ?? 0);
      
      if(isToday){
        // ä»Šæ—¥æ¨¡å¼
        const rechargeToday = Number(kpiData.recharge_today ?? 0);
        compareText = `æ˜¨æ—¥ ${fmtVal(previousUsage)}ï¼Œä»Šæ—¥ ${fmtVal(currentUsage)}`;
        if(rechargeToday > 0) rechargeInfo = `ï¼Œå……å€¼ ${fmtVal(rechargeToday)}`;
      } else {
        // å†å²æ—¥æœŸæ¨¡å¼
        compareText = `${currentDate} å½“æ—¥ç”¨ç”µ`;
      }
      
    } else {
      // å‘¨/æœˆæ¨¡å¼ï¼šä½¿ç”¨å›¾è¡¨æ•°æ®æ±‡æ€» + /period_kpi å¯¹æ¯”
      const usage = Array.isArray(chartData.usage) ? chartData.usage : [];
      currentUsage = usage.reduce((sum, val) => sum + Number(val || 0), 0);
      
      // ä½¿ç”¨ /period_kpi è·å–ä¸Šå‘¨æœŸæ•°æ®
      previousUsage = Number(periodData.previous_usage ?? 0);
      
      const periodName = period === 'week' ? 'å‘¨' : 'æœˆ';
      compareText = `ä¸Š${periodName} ${fmtVal(previousUsage)}ï¼Œæœ¬${periodName} ${fmtVal(currentUsage)}`;
    }
    
    // æ›´æ–° UI
    document.getElementById('kpi-balance').textContent = fmtVal(currentBalance);
    document.getElementById('kpi-today').textContent = fmtVal(currentUsage);
    
    // åˆ¤æ–­æ˜¯å¦ä¸ºä»Šæ—¥æˆ–ä»Šæ—¥æ¨¡å¼ï¼Œå†³å®šæ˜¯å¦æ˜¾ç¤ºå¯¹æ¯”å’Œé¢„è®¡å¤©æ•°
    const todayStr = getTodayInChina(); // ä½¿ç”¨ä¸­å›½æ—¶åŒº
    const isToday = currentDate === todayStr;
    const showComparison = (period === 'day' && isToday) || period !== 'day';
    
    if(showComparison){
      // æ˜¾ç¤ºå¯¹æ¯”æ•°æ®
      const diff = currentUsage - previousUsage;
      const diffEl = document.getElementById('kpi-compare');
      diffEl.textContent = `${diff>=0?'+':''}${fmtVal(diff)}`;
      diffEl.className = 'value ' + (diff>=0 ? 'up' : 'down');
      document.getElementById('kpi-compare-sub').textContent = compareText + rechargeInfo;
      
      // æ˜¾ç¤ºé¢„è®¡å¯ç”¨å¤©æ•°ï¼ˆåªåœ¨ä»Šæ—¥æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰
      if(period === 'day' && isToday){
        const labelsW = Array.isArray(weekData.labels) ? weekData.labels : [];
        const usageW = Array.isArray(weekData.usage) ? weekData.usage : [];
        const todayIdx = labelsW.indexOf(todayStr);
        const validUsage = usageW.filter((_,i)=> i!==todayIdx).map(Number).filter(v=>v>0);
        const avg7 = validUsage.length ? validUsage.reduce((a,b)=>a+b,0)/validUsage.length : 0;
        const days = avg7 > 0 ? (currentBalance / avg7) : Infinity;
        document.getElementById('kpi-days').textContent = isFinite(days) ? fmtVal(days) : 'âˆ';
      } else {
        document.getElementById('kpi-days').textContent = '--';
      }
    } else {
      // å†å²æ—¥æœŸï¼šéšè—å¯¹æ¯”æ•°æ®
      document.getElementById('kpi-compare').textContent = '--';
      document.getElementById('kpi-compare').className = 'value';
      document.getElementById('kpi-compare-sub').textContent = compareText;
      document.getElementById('kpi-days').textContent = '--';
    }
    
  }).catch(err=>{
    // æŠ¥é”™æ—¶å…œåº•æ˜¾ç¤º 0
    document.getElementById('kpi-balance').textContent = fmtVal(0);
    document.getElementById('kpi-today').textContent = fmtVal(0);
    document.getElementById('kpi-compare').textContent = fmtVal(0);
    document.getElementById('kpi-compare-sub').textContent = '';
    document.getElementById('kpi-days').textContent = 'âˆ';
    console.error('kpi fetch error', err);
  });
}

/* åŠ è½½å¹¶æ˜¾ç¤ºæ•°æ®ï¼ˆperiod = 'day'|'week'|'month'ï¼‰ */
function loadData(period){
  currentPeriod = period;
  // ç»™ period æŒ‰é’®åšé«˜äº®ï¼ˆé»˜è®¤è¡Œä¸ºï¼‰â€”â€”ä½†æ³¨æ„ï¼šå½“ç”±æ—¥æœŸé€‰æ‹©è§¦å‘ä¸”é€‰ä¸­éä»Šæ—¥æ—¶ï¼Œåé¢ä¼šå–æ¶ˆä»Šæ—¥é«˜äº®
  document.querySelectorAll('.period-btn').forEach(btn=>{
    if(btn.dataset.period === period) btn.classList.add('active'); else btn.classList.remove('active');
  });

  const deviceId = document.getElementById('deviceSelect').value;
  const dateParam = (period === 'day') ? `&date=${encodeURIComponent(currentDate)}` : '';

  // å¹¶è¡Œæ‹‰å–å½“å‰å‘¨æœŸæ•°æ® + æ—¥æ•°æ® + å‘¨æ•°æ®ï¼ˆç”¨äº KPI è®¡ç®—ï¼‰
  Promise.all([
    fetch(`/data?period=${period}&device_id=${deviceId}${dateParam}`).then(r=>r.json()).catch(()=>({labels:[], balances:[], usage:[]}) ),
    fetch(`/data?period=day&device_id=${deviceId}`).then(r=>r.json()).catch(()=>({labels:[], balances:[], usage:[]}) ),
    fetch(`/data?period=week&device_id=${deviceId}`).then(r=>r.json()).catch(()=>({labels:[], balances:[], usage:[]}) )
  ]).then(([chartRes = {}, dayRes = {}, weekRes = {}])=>{
    const labels = Array.isArray(chartRes.labels) ? chartRes.labels : [];
    const balances = Array.isArray(chartRes.balances) ? chartRes.balances : [];
    const usage = Array.isArray(chartRes.usage) ? chartRes.usage : [];

    // å¦‚æœ labels ä¸ºç©ºæç¤º
    if(labels.length === 0){
      document.getElementById('status').innerText = 'æš‚æ— æ•°æ®ï¼Œå…ˆæŠ“å–æˆ–ç¨åå†è¯•';
    } else {
      document.getElementById('status').innerText = '';
    }

    renderSeparatedCharts(labels, balances, usage);

    // æ—¶é—´èŒƒå›´æ˜¾ç¤º
    const rangeEl = document.getElementById('rangeIndicator');
    if(period === 'day'){
      rangeEl.textContent = `å½“å‰æ—¥æœŸï¼š${currentDate}`;
    } else if(period === 'week'){
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - 6);
      rangeEl.textContent = `æ—¶é—´æ®µï¼š${fmtDate(start)} ~ ${fmtDate(end)}`;
    } else {
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - 29);
      rangeEl.textContent = `æ—¶é—´æ®µï¼š${fmtDate(start)} ~ ${fmtDate(end)}`;
    }

    // æ ‡ç­¾æ–‡å­—åˆ‡æ¢
    const labelEl = document.getElementById('kpi-usage-label');
    labelEl.textContent = period === 'day' ? 'å½“æ—¥ç”¨ç”µ' : (period === 'week' ? 'è¿‘7å¤©ç”¨ç”µ' : 'è¿‘30å¤©ç”¨ç”µ');
    const compareLabel = document.getElementById('kpi-compare-label');
    compareLabel.textContent = period === 'day' ? 'è¾ƒæ˜¨æ—¥' : 'è¾ƒä¸Šå‘¨æœŸ';

    // æ›´æ–° KPIï¼ˆä¼ å…¥å½“å‰å‘¨æœŸå’Œæ‰€æœ‰ç›¸å…³æ•°æ®ï¼‰
    updateKpis(period, chartRes, dayRes, weekRes);
  }).catch(err=>{
    console.error('loadData error', err);
    document.getElementById('status').innerText = 'æ•°æ®åŠ è½½å¤±è´¥';
  });
}

// æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD
function fmtDate(d){
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${d.getFullYear()}-${m}-${day}`;
}

/* æ‰‹åŠ¨æŠ“å–ä¸€æ¬¡ */
function fetchData(){
  const deviceId = document.getElementById('deviceSelect').value;
  document.getElementById('status').innerText = 'æŠ“å–ä¸­...';
  fetch(`/fetch?device_id=${deviceId}`).then(r=>r.json()).then(res=>{
    document.getElementById('status').innerText = res.message || 'æŠ“å–å®Œæˆ';
    // è§¦å‘åˆ·æ–°
    loadData(currentPeriod);
  }).catch(err=>{
    document.getElementById('status').innerText = 'æŠ“å–å¤±è´¥';
    console.error(err);
  });
}

/* ä»Šæ—¥æŒ‰é’®ï¼šè®¾ç½®æ—¥æœŸé€‰æ‹©å™¨ä¸ºä»Šå¤©ï¼Œå¹¶åŠ è½½ day æ•°æ®ï¼›ä¸è¦ä½¿ç”¨ datePicker._flatpickrï¼ˆä¸å¯é ï¼‰ */
function showToday(){
  currentPeriod = 'day';
  currentDate = getTodayInChina(); // ä½¿ç”¨ä¸­å›½æ—¶åŒº
  if(datePicker){
    // ç¬¬äºŒä¸ªå‚æ•° false è¡¨ç¤ºä¸è§¦å‘ onChange å›è°ƒâ€”â€”æˆ‘ä»¬ä¸‹é¢æ‰‹åŠ¨è°ƒç”¨ loadData
    datePicker.setDate(currentDate, false);
  }
  // æ˜¾ç¤ºç»Ÿè®¡è§†å›¾ï¼Œéšè—å……å€¼å†å²
  showStatisticsView();
  // è®¾ç½®æŒ‰é’®é«˜äº®
  document.querySelectorAll('.period-btn').forEach(btn=>btn.classList.remove('active'));
  document.getElementById('todayBtn').classList.add('active');
  loadData('day');
}

/* æ˜¾ç¤ºå……å€¼å†å² */
function showRechargeHistory(){
  currentPeriod = 'recharge';
  // æ˜¾ç¤ºå……å€¼å†å²è§†å›¾ï¼Œéšè—ç»Ÿè®¡è§†å›¾
  showRechargeView();
  // è®¾ç½®æŒ‰é’®é«˜äº®
  document.querySelectorAll('.period-btn').forEach(btn=>btn.classList.remove('active'));
  document.getElementById('rechargeBtn').classList.add('active');
  // æ›´æ–°èŒƒå›´æŒ‡ç¤ºå™¨
  document.getElementById('rangeIndicator').textContent = 'å……å€¼å†å²è®°å½•';
  // åŠ è½½å……å€¼å†å²æ•°æ®
  loadRechargeHistory();
}

/* æ˜¾ç¤ºç»Ÿè®¡è§†å›¾ */
function showStatisticsView(){
  document.getElementById('statisticsView').style.display = 'block';
  document.getElementById('rechargeHistoryView').classList.remove('active');
}

/* æ˜¾ç¤ºå……å€¼å†å²è§†å›¾ */
function showRechargeView(){
  document.getElementById('statisticsView').style.display = 'none';
  document.getElementById('rechargeHistoryView').classList.add('active');
}

/* åŠ è½½å……å€¼å†å²æ•°æ® */
function loadRechargeHistory(){
  const deviceId = document.getElementById('deviceSelect').value;
  const days = document.getElementById('rechargeDays').value;
  
  document.getElementById('status').textContent = 'åŠ è½½å……å€¼å†å²...';
  
  fetch(`/recharge_history?device_id=${deviceId}&days=${days}`)
    .then(r => r.json())
    .then(data => {
      renderRechargeHistory(data);
      document.getElementById('status').textContent = '';
    })
    .catch(err => {
      console.error('åŠ è½½å……å€¼å†å²å¤±è´¥:', err);
      document.getElementById('status').textContent = 'åŠ è½½å……å€¼å†å²å¤±è´¥';
      document.getElementById('rechargeList').innerHTML = '<div class="no-recharge">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
    });
}

/* æ¸²æŸ“å……å€¼å†å²è®°å½• */
function renderRechargeHistory(data){
  const recharges = data.recharges || [];
  const totalCount = data.total_count || 0;
  const queryDays = data.query_days || 30;
  
  // æ›´æ–°æ‘˜è¦ä¿¡æ¯
  const summaryEl = document.getElementById('rechargeSummary');
  if(totalCount === 0){
    summaryEl.textContent = `è¿‘${queryDays}å¤©æ— å……å€¼è®°å½•`;
  } else {
    const totalAmount = recharges.reduce((sum, r) => sum + (r.recharge_amount || 0), 0);
    summaryEl.textContent = `è¿‘${queryDays}å¤©å…±${totalCount}æ¬¡å……å€¼ï¼Œç´¯è®¡${totalAmount.toFixed(2)}å…ƒ`;
  }
  
  // æ¸²æŸ“å……å€¼è®°å½•åˆ—è¡¨
  const listEl = document.getElementById('rechargeList');
  if(recharges.length === 0){
    listEl.innerHTML = '<div class="no-recharge">ğŸ“­ æš‚æ— å……å€¼è®°å½•</div>';
    return;
  }
  
  const rechargeItems = recharges.map(recharge => {
    const date = recharge.recharge_date;
    const time = recharge.recharge_time;
    const amount = recharge.recharge_amount;
    const balanceBefore = recharge.balance_before;
    const balanceAfter = recharge.balance_after;
    
    return `
      <div class="recharge-item">
        <div class="recharge-info">
          <div class="recharge-date">${date}</div>
          <div class="recharge-time">${time}</div>
        </div>
        <div class="recharge-amount">
          <div class="recharge-money">+${amount}å…ƒ</div>
          <div class="recharge-balance">${balanceBefore} â†’ ${balanceAfter}</div>
        </div>
      </div>
    `;
  }).join('');
  
  listEl.innerHTML = rechargeItems;
}

/* é¡µé¢åˆå§‹åŒ–ï¼šè§£æ devices-jsonã€åˆå§‹åŒ– flatpickrã€åˆå§‹åŒ–äº‹ä»¶ */
document.addEventListener('DOMContentLoaded', ()=>{
  // ä»é¡µé¢å†… JSON è¯»å–è®¾å¤‡åˆ—è¡¨ï¼ˆæ¨¡æ¿é‡Œç”±åç«¯æ³¨å…¥ï¼‰
  const el = document.getElementById('devices-json');
  try { devices = JSON.parse(el ? el.textContent : '[]'); } catch(e){ devices = []; }

  // å¡«å……è®¾å¤‡ä¸‹æ‹‰
  const sel = document.getElementById('deviceSelect');
  sel.innerHTML = (devices || []).map(d=>`<option value="${d.id}">${d.name}</option>`).join('');
  if((devices || []).length === 0){
    // å¦‚æœæ¨¡æ¿æ²¡æœ‰æ³¨å…¥ devicesï¼Œå¯ä»¥æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªå ä½ï¼ˆé˜²æ­¢ç©ºï¼‰
    sel.innerHTML = `<option value="19101109825">é»˜è®¤è®¾å¤‡</option>`;
  }

  // åˆå§‹åŒ– flatpickr å¹¶ä¿ç•™å®ä¾‹
  datePicker = flatpickr("#datePicker", {
    locale: "zh",
    dateFormat: "Y-m-d",
    defaultDate: currentDate,
    onChange: function(selectedDates, dateStr){
      currentDate = dateStr || currentDate;
      currentPeriod = 'day';
      // å…ˆåŠ è½½æ•°æ®ï¼ˆé»˜è®¤ä¼šæŠŠ day çš„æŒ‰é’®é«˜äº®ï¼‰ï¼Œéšåå¦‚æœé€‰ä¸­çš„ä¸æ˜¯ä»Šå¤©ï¼Œåˆ™å–æ¶ˆä»Šæ—¥æŒ‰é’®é«˜äº®
      loadData('day');
      const todayStr = getTodayInChina(); // ä½¿ç”¨ä¸­å›½æ—¶åŒº
      if(dateStr !== todayStr){
        // å–æ¶ˆä»Šæ—¥æŒ‰é’®é«˜äº®ï¼ˆå› ä¸ºé€‰ä¸­äº†å…¶å®ƒæ—¥æœŸï¼‰
        document.querySelectorAll('.period-btn').forEach(btn=>btn.classList.remove('active'));
      } else {
        // é€‰ä¸­äº†ä»Šå¤©ï¼Œç¡®ä¿ä»Šæ—¥é«˜äº®
        document.querySelectorAll('.period-btn').forEach(btn=>btn.classList.remove('active'));
        document.getElementById('todayBtn').classList.add('active');
      }
    }
  });

  // å¯åŠ¨æ—¶æ˜¾ç¤ºä»Šæ—¥
  showToday();
  
  // è®¾ç½®å®šæœŸæ£€æŸ¥æœºåˆ¶ï¼Œæ¯30ç§’æ£€æŸ¥ä¸€æ¬¡æ—¥æœŸæ˜¯å¦è·¨æ—¥
  setInterval(checkAndUpdateDate, 30000); // 30ç§’æ£€æŸ¥ä¸€æ¬¡
});
</script>

<!-- åç«¯æ¨¡æ¿ä¼šæ³¨å…¥ devices JSON -->
<script type="application/json" id="devices-json">{{ devices|tojson }}</script>
</body>
</html>
