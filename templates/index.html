<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>电表统计</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<style>
:root{
  --bg:#f7f8fa;--card:#fff;--text:#111;--muted:#6b7280;--primary:#0ea5e9;--accent:#ef4444;
}
*{box-sizing:border-box}
html,body{height:100%}
body { font-family: sans-serif; margin:0; background:#f9f9f9; color:#111; }
header {
  padding:10px;
  background: linear-gradient(90deg, #4a90e2, #357ab8);
  color:#fff;
  display:flex;
  align-items:center;
  flex-wrap:wrap;
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
}

header select,
header input {
  margin-left:10px;
  padding:6px 10px;
  border-radius:6px;
  border:none;
  background:#fff;
  color:#333;
  box-shadow:0 1px 3px rgba(0,0,0,0.1);
  font-size:14px;
  transition: all 0.2s ease;
}
header select:focus,
header input:focus {
  outline:none;
  box-shadow:0 0 0 2px rgba(74,144,226,0.4);
}

.toolbar {
  display:flex;
  gap:10px;
  margin-left:auto;
  flex-wrap:wrap;
}

.period-btn {
  padding:6px 14px;
  border:none;
  border-radius:20px;
  cursor:pointer;
  background:#fff;
  color:#4a90e2;
  font-size:14px;
  font-weight:500;
  box-shadow:0 1px 3px rgba(0,0,0,0.1);
  transition: all 0.25s ease;
}
.period-btn:hover {
  background:#f0f4fa;
}

button {
  cursor:pointer;
}

/* 抓取按钮单独样式 */
.fetch-btn {
  padding:6px 18px;
  border:none;
  border-radius:20px;
  cursor:pointer;
  background:#ff9800;   /* 橙色主按钮 */
  color:#fff;
  font-size:14px;
  font-weight:600;
  box-shadow:0 2px 6px rgba(0,0,0,0.2);
  transition: all 0.25s ease;
}
.fetch-btn:hover {
  background:#e68900;
  transform:scale(1.05);
}

.period-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}

.primary{background:var(--primary);color:#fff;border:none}
.container{padding:12px}
.section{margin-bottom:14px}
.card{background:var(--card);border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:10px}
.chart-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
.chart-inner{min-width:600px}
.title{margin:6px 0 8px 4px;font-size:18px;color:var(--muted)}
canvas{width:100% !important;height:300px !important}
@media(min-width:768px){canvas{height:360px !important}}
.status{margin:8px 4px;color:var(--muted)}
.range{margin:6px 4px;color:var(--muted);font-size:13px}
/* KPI cards */
.kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
@media(min-width:768px){.kpis{grid-template-columns:repeat(4,1fr)}}
.kpi{background:var(--card);border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:10px}
.kpi .label{font-size:13px;color:var(--muted)}
.kpi .value{font-size:20px;font-weight:600;margin-top:6px}
.kpi .sub{font-size:12px;color:var(--muted);margin-top:4px}
.up{color:#16a34a}
.down{color:#ef4444}
/* 手机端 header 响应式 */
@media(max-width:768px){
  header {
    flex-direction: column;
    align-items: stretch;
    padding: 10px 8px; /* 增加左右 padding */
    gap: 6px; /* header 内元素上下间距 */
  }

  header span {
    font-size: 16px;
    margin-bottom: 6px;
  }

  .header-row {
    display: flex;
    gap: 6px;
    width: 100%;
  }

  .header-row select,
  .header-row input {
    flex: 1;
    min-width: 0;
    padding: 6px 8px; /* 减小高度，避免拥挤 */
    font-size: 14px;
  }

  .toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    width: 100%;
    margin-top: 4px; /* 按钮行与上方间距 */
  }

  .toolbar button {
    flex: 1 1 auto;
    min-width: 80px;
    padding: 6px 0; /* 减少按钮高度 */
    font-size: 14px;
  }
}

</style>
</head>
<body>

<header>
  <span>电表可视化</span>
  <div class="header-row">
    <select id="deviceSelect" onchange="loadData(currentPeriod)"></select>
    <input type="text" id="datePicker" placeholder="选择日期">
  </div>
  <div class="toolbar">
    <button class="period-btn" id="todayBtn" data-period="day" onclick="showToday()">今日</button>
    <button class="period-btn" data-period="week" onclick="loadData('week')">近7天</button>
    <button class="period-btn" data-period="month" onclick="loadData('month')">近30天</button>
    <button class="fetch-btn" onclick="fetchData()">抓取</button>

  </div>
</header>

<div class="container">
  <p id="rangeIndicator" class="range"></p>
  <div class="kpis">
    <div class="kpi">
      <div class="label">当前余额</div>
      <div class="value" id="kpi-balance">--</div>
      <div class="sub">单位：元</div>
    </div>
    <div class="kpi">
      <div class="label" id="kpi-usage-label">今日用电</div>
      <div class="value" id="kpi-today">--</div>
      <div class="sub">单位：度</div>
    </div>
    <div class="kpi">
      <div class="label" id="kpi-compare-label">较昨日</div>
      <div class="value" id="kpi-compare">--</div>
      <div class="sub" id="kpi-compare-sub"></div>
    </div>
    <div class="kpi">
      <div class="label">预计可用天数</div>
      <div class="value" id="kpi-days">--</div>
      <div class="sub">基于近7天日均</div>
    </div>
  </div>
  <div class="section">
    <div class="title">用电量趋势</div>
    <div class="card">
      <div class="chart-scroll" id="balanceScroll">
        <div class="chart-inner" id="balanceChartInner">
          <canvas id="balanceLineChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  <div class="section">
    <div class="title">余额</div>
    <div class="card">
      <div class="chart-scroll" id="usageScroll">
        <div class="chart-inner" id="usageChartInner">
          <canvas id="usageBarChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  <p id="status" class="status"></p>
</div>

<script>
/* 全局变量 */
let devices = [];
const isMobile = window.matchMedia('(max-width: 768px)').matches;
let usageLineChart = null, balanceBarChart = null;
let currentPeriod = 'day';
let currentDate = new Date().toISOString().slice(0,10);
let datePicker = null;

/* 注册 ChartDataLabels（如果被加载） */
if (window.Chart && window.ChartDataLabels) {
  Chart.register(ChartDataLabels);
}

/* 小工具：安全格式化数字 */
function fmt(n){ return Number(n ?? 0).toFixed(2); }

/* 安全将后端的 ISO 日期字符串转换为 "月-日"（避免 new Date 在不同浏览器的兼容问题） */
function shortLabelFromISO(d){
  if(!d) return d;
  if(typeof d !== 'string') d = String(d);
  if(d.includes('-')){
    const parts = d.split('-');
    if(parts.length >= 3){
      return `${Number(parts[1])}-${Number(parts[2])}`;
    }
  }
  // 回退解析（尽量不依赖）
  const dt = new Date(d);
  if(!isNaN(dt.getTime())){
    return `${dt.getMonth()+1}-${dt.getDate()}`;
  }
  return d;
}

/* 渲染两个分开的图表：第一个是用电量（折线），第二个是余额（柱/折线） */
/* labels: array of 'YYYY-MM-DD'；balances: array；usage: array */
function renderSeparatedCharts(labels = [], balances = [], usage = []){
  // 防御式：确保为数组
  labels = Array.isArray(labels) ? labels : [];
  balances = Array.isArray(balances) ? balances : [];
  usage = Array.isArray(usage) ? usage : [];

  // 仅用于显示的短标签（只显示月-日）
  const displayLabels = labels.map(d => shortLabelFromISO(d));

  const perPoint = isMobile ? 36 : 24;
  const inner1 = document.getElementById('balanceChartInner');
  inner1.style.width = Math.max(inner1.clientWidth, displayLabels.length * perPoint + 80) + 'px';
  const ctx1 = document.getElementById('balanceLineChart').getContext('2d');
  if(usageLineChart) usageLineChart.destroy();
  usageLineChart = new Chart(ctx1, {
    type:'line',
    data:{ labels: displayLabels, datasets:[{ label:'用电量', data:usage, borderColor:'rgba(239,68,68,1)', backgroundColor:'rgba(239,68,68,0.15)', tension:0.25, fill:true, pointRadius:0, borderWidth:2 }] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      layout:{padding:{top:16,right:8,bottom:0,left:8}},
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{display:false},
        tooltip:{ enabled:true, callbacks:{label:(ctx)=>`${ctx.dataset.label}: ${Number(ctx.parsed.y??ctx.raw).toFixed(2)}` } },
        datalabels:{
          display: true,
          formatter:(v)=>Number(v).toFixed(2),
          color:'#111',
          backgroundColor:'rgba(255,255,255,0.85)',
          borderRadius:6,
          padding:{top:2,right:4,bottom:2,left:4},
          anchor:'end',align:'end',offset: -2,clamp:true
        }
      },
      scales:{
        y:{ beginAtZero:true, grid:{color:'rgba(0,0,0,0.06)'}, ticks:{callback:(v)=>Number(v).toFixed(2)} },
        x:{ grid:{display:false}, ticks:{ autoSkip:false, maxRotation:0 } }
      }
    },
    plugins: [ ChartDataLabels ]
  });

  const inner2 = document.getElementById('usageChartInner');
  inner2.style.width = Math.max(inner2.clientWidth, displayLabels.length * perPoint + 80) + 'px';
  const ctx2 = document.getElementById('usageBarChart').getContext('2d');
  if(balanceBarChart) balanceBarChart.destroy();
  balanceBarChart = new Chart(ctx2, {
    type:'bar',
    data:{ labels: displayLabels, datasets:[{ label:'余额', data:balances, backgroundColor:'rgba(14,165,233,0.65)', borderColor:'rgba(14,165,233,1)', borderWidth:1, borderRadius:6, maxBarThickness:isMobile?18:32, categoryPercentage:0.5, barPercentage:0.8 }] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      layout:{padding:{top:16,right:8,bottom:0,left:8}},
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{display:false},
        tooltip:{ enabled:true, callbacks:{label:(ctx)=>`${ctx.dataset.label}: ${Number(ctx.parsed.y??ctx.raw).toFixed(2)}` } },
        datalabels:{
          display:true,
          formatter:(v)=>Number(v).toFixed(2),
          color:'#111',
          backgroundColor:'rgba(255,255,255,0.85)',
          borderRadius:6,
          padding:{top:2,right:4,bottom:2,left:4},
          anchor:'end',align:'end',offset:-2,clamp:true
        }
      },
      scales:{
        y:{ beginAtZero:true, grid:{color:'rgba(0,0,0,0.06)'}, ticks:{callback:(v)=>Number(v).toFixed(2)} },
        x:{ grid:{display:false}, ticks:{ autoSkip:false, maxRotation:0 } }
      }
    },
    plugins: [ ChartDataLabels ]
  });
}

/* 更新 KPI：根据当前周期动态显示对应的用电量和对比数据 */
function updateKpis(period, chartData = {}, dayData = {}, weekData = {}){
  const fmtVal = (n)=>Number(n ?? 0).toFixed(2);
  const deviceId = document.getElementById('deviceSelect').value;
  
  // 并行获取基础数据
  Promise.all([
    fetch(`/kpi?device_id=${deviceId}`).then(r=>r.json()).catch(()=>({})),
    period !== 'day' ? fetch(`/period_kpi?period=${period}&device_id=${deviceId}`).then(r=>r.json()).catch(()=>({})) : Promise.resolve({})
  ]).then(([kpiData = {}, periodData = {}])=>{
    const currentBalance = Number(kpiData.current_balance ?? 0);
    
    // 根据周期计算当前用电量和对比数据
    let currentUsage = 0;
    let previousUsage = 0;
    let compareText = '';
    let rechargeInfo = '';
    
    if(period === 'day'){
      // 日模式：判断是否选择的今日
      const todayStr = new Date().toISOString().slice(0,10);
      const isToday = currentDate === todayStr;
      
      if(isToday){
        // 选择今日：优先使用 /kpi 接口数据
        currentUsage = Number(kpiData.usage_today ?? 0);
        previousUsage = Number(kpiData.usage_yesterday ?? 0);
        const rechargeToday = Number(kpiData.recharge_today ?? 0);
        
        // 回退计算：如果 /kpi 没有数据，用 dayData 计算
        if(currentUsage === 0 && dayData.balances){
          const balances = Array.isArray(dayData.balances) ? dayData.balances : [];
          const valid = balances.filter(v => v !== null && v !== undefined && !isNaN(Number(v))).map(Number);
          if(valid.length >= 2){
            currentUsage = Math.max(valid[0] - valid[valid.length - 1], 0);
          }
        }
        
        compareText = `昨日 ${fmtVal(previousUsage)}，今日 ${fmtVal(currentUsage)}`;
        if(rechargeToday > 0) rechargeInfo = `，充值 ${fmtVal(rechargeToday)}`;
        
      } else {
        // 选择非今日：使用 chartData 计算该日期的用电量（chartData 包含正确的日期数据）
        const balances = Array.isArray(chartData.balances) ? chartData.balances : [];
        const valid = balances.filter(v => v !== null && v !== undefined && !isNaN(Number(v))).map(Number);
        
        if(valid.length >= 2){
          currentUsage = Math.max(valid[0] - valid[valid.length - 1], 0);
        } else {
          currentUsage = 0;
        }
        
        // 对于历史日期，不显示对比数据和预计天数
        previousUsage = 0;
        compareText = `${currentDate} 当日用电`;
      }
      
    } else {
      // 周/月模式：使用图表数据汇总 + /period_kpi 对比
      const usage = Array.isArray(chartData.usage) ? chartData.usage : [];
      currentUsage = usage.reduce((sum, val) => sum + Number(val || 0), 0);
      
      // 使用 /period_kpi 获取上周期数据
      previousUsage = Number(periodData.previous_usage ?? 0);
      
      const periodName = period === 'week' ? '周' : '月';
      compareText = `上${periodName} ${fmtVal(previousUsage)}，本${periodName} ${fmtVal(currentUsage)}`;
    }
    
    // 更新 UI
    document.getElementById('kpi-balance').textContent = fmtVal(currentBalance);
    document.getElementById('kpi-today').textContent = fmtVal(currentUsage);
    
    // 判断是否为今日或今日模式，决定是否显示对比和预计天数
    const todayStr = new Date().toISOString().slice(0,10);
    const isToday = currentDate === todayStr;
    const showComparison = (period === 'day' && isToday) || period !== 'day';
    
    if(showComparison){
      // 显示对比数据
      const diff = currentUsage - previousUsage;
      const diffEl = document.getElementById('kpi-compare');
      diffEl.textContent = `${diff>=0?'+':''}${fmtVal(diff)}`;
      diffEl.className = 'value ' + (diff>=0 ? 'up' : 'down');
      document.getElementById('kpi-compare-sub').textContent = compareText + rechargeInfo;
      
      // 显示预计可用天数（只在今日模式下显示）
      if(period === 'day' && isToday){
        const labelsW = Array.isArray(weekData.labels) ? weekData.labels : [];
        const usageW = Array.isArray(weekData.usage) ? weekData.usage : [];
        const todayIdx = labelsW.indexOf(todayStr);
        const validUsage = usageW.filter((_,i)=> i!==todayIdx).map(Number).filter(v=>v>0);
        const avg7 = validUsage.length ? validUsage.reduce((a,b)=>a+b,0)/validUsage.length : 0;
        const days = avg7 > 0 ? (currentBalance / avg7) : Infinity;
        document.getElementById('kpi-days').textContent = isFinite(days) ? fmtVal(days) : '∞';
      } else {
        document.getElementById('kpi-days').textContent = '--';
      }
    } else {
      // 历史日期：隐藏对比数据
      document.getElementById('kpi-compare').textContent = '--';
      document.getElementById('kpi-compare').className = 'value';
      document.getElementById('kpi-compare-sub').textContent = compareText;
      document.getElementById('kpi-days').textContent = '--';
    }
    
  }).catch(err=>{
    // 报错时兜底显示 0
    document.getElementById('kpi-balance').textContent = fmtVal(0);
    document.getElementById('kpi-today').textContent = fmtVal(0);
    document.getElementById('kpi-compare').textContent = fmtVal(0);
    document.getElementById('kpi-compare-sub').textContent = '';
    document.getElementById('kpi-days').textContent = '∞';
    console.error('kpi fetch error', err);
  });
}

/* 加载并显示数据（period = 'day'|'week'|'month'） */
function loadData(period){
  currentPeriod = period;
  // 给 period 按钮做高亮（默认行为）——但注意：当由日期选择触发且选中非今日时，后面会取消今日高亮
  document.querySelectorAll('.period-btn').forEach(btn=>{
    if(btn.dataset.period === period) btn.classList.add('active'); else btn.classList.remove('active');
  });

  const deviceId = document.getElementById('deviceSelect').value;
  const dateParam = (period === 'day') ? `&date=${encodeURIComponent(currentDate)}` : '';

  // 并行拉取当前周期数据 + 日数据 + 周数据（用于 KPI 计算）
  Promise.all([
    fetch(`/data?period=${period}&device_id=${deviceId}${dateParam}`).then(r=>r.json()).catch(()=>({labels:[], balances:[], usage:[]}) ),
    fetch(`/data?period=day&device_id=${deviceId}`).then(r=>r.json()).catch(()=>({labels:[], balances:[], usage:[]}) ),
    fetch(`/data?period=week&device_id=${deviceId}`).then(r=>r.json()).catch(()=>({labels:[], balances:[], usage:[]}) )
  ]).then(([chartRes = {}, dayRes = {}, weekRes = {}])=>{
    const labels = Array.isArray(chartRes.labels) ? chartRes.labels : [];
    const balances = Array.isArray(chartRes.balances) ? chartRes.balances : [];
    const usage = Array.isArray(chartRes.usage) ? chartRes.usage : [];

    // 如果 labels 为空提示
    if(labels.length === 0){
      document.getElementById('status').innerText = '暂无数据，先抓取或稍后再试';
    } else {
      document.getElementById('status').innerText = '';
    }

    renderSeparatedCharts(labels, balances, usage);

    // 时间范围显示
    const rangeEl = document.getElementById('rangeIndicator');
    if(period === 'day'){
      rangeEl.textContent = `当前日期：${currentDate}`;
    } else if(period === 'week'){
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - 6);
      rangeEl.textContent = `时间段：${fmtDate(start)} ~ ${fmtDate(end)}`;
    } else {
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - 29);
      rangeEl.textContent = `时间段：${fmtDate(start)} ~ ${fmtDate(end)}`;
    }

    // 标签文字切换
    const labelEl = document.getElementById('kpi-usage-label');
    labelEl.textContent = period === 'day' ? '当日用电' : (period === 'week' ? '近7天用电' : '近30天用电');
    const compareLabel = document.getElementById('kpi-compare-label');
    compareLabel.textContent = period === 'day' ? '较昨日' : '较上周期';

    // 更新 KPI（传入当前周期和所有相关数据）
    updateKpis(period, chartRes, dayRes, weekRes);
  }).catch(err=>{
    console.error('loadData error', err);
    document.getElementById('status').innerText = '数据加载失败';
  });
}

// 格式化日期为 YYYY-MM-DD
function fmtDate(d){
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${d.getFullYear()}-${m}-${day}`;
}

/* 手动抓取一次 */
function fetchData(){
  const deviceId = document.getElementById('deviceSelect').value;
  document.getElementById('status').innerText = '抓取中...';
  fetch(`/fetch?device_id=${deviceId}`).then(r=>r.json()).then(res=>{
    document.getElementById('status').innerText = res.message || '抓取完成';
    // 触发刷新
    loadData(currentPeriod);
  }).catch(err=>{
    document.getElementById('status').innerText = '抓取失败';
    console.error(err);
  });
}

/* 今日按钮：设置日期选择器为今天，并加载 day 数据；不要使用 datePicker._flatpickr（不可靠） */
function showToday(){
  currentPeriod = 'day';
  currentDate = new Date().toISOString().slice(0,10);
  if(datePicker){
    // 第二个参数 false 表示不触发 onChange 回调——我们下面手动调用 loadData
    datePicker.setDate(currentDate, false);
  }
  // 设置按钮高亮
  document.querySelectorAll('.period-btn').forEach(btn=>btn.classList.remove('active'));
  document.getElementById('todayBtn').classList.add('active');
  loadData('day');
}

/* 页面初始化：解析 devices-json、初始化 flatpickr、初始化事件 */
document.addEventListener('DOMContentLoaded', ()=>{
  // 从页面内 JSON 读取设备列表（模板里由后端注入）
  const el = document.getElementById('devices-json');
  try { devices = JSON.parse(el ? el.textContent : '[]'); } catch(e){ devices = []; }

  // 填充设备下拉
  const sel = document.getElementById('deviceSelect');
  sel.innerHTML = (devices || []).map(d=>`<option value="${d.id}">${d.name}</option>`).join('');
  if((devices || []).length === 0){
    // 如果模板没有注入 devices，可以手动添加一个占位（防止空）
    sel.innerHTML = `<option value="19101109825">默认设备</option>`;
  }

  // 初始化 flatpickr 并保留实例
  datePicker = flatpickr("#datePicker", {
    locale: "zh",
    dateFormat: "Y-m-d",
    defaultDate: currentDate,
    onChange: function(selectedDates, dateStr){
      currentDate = dateStr || currentDate;
      currentPeriod = 'day';
      // 先加载数据（默认会把 day 的按钮高亮），随后如果选中的不是今天，则取消今日按钮高亮
      loadData('day');
      const todayStr = new Date().toISOString().slice(0,10);
      if(dateStr !== todayStr){
        // 取消今日按钮高亮（因为选中了其它日期）
        document.querySelectorAll('.period-btn').forEach(btn=>btn.classList.remove('active'));
      } else {
        // 选中了今天，确保今日高亮
        document.querySelectorAll('.period-btn').forEach(btn=>btn.classList.remove('active'));
        document.getElementById('todayBtn').classList.add('active');
      }
    }
  });

  // 启动时显示今日
  showToday();
});
</script>

<!-- 后端模板会注入 devices JSON -->
<script type="application/json" id="devices-json">{{ devices|tojson }}</script>
</body>
</html>
