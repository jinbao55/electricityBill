<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>电表统计</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<style>
:root{
  --bg:#f7f8fa;--card:#fff;--text:#111;--muted:#6b7280;--primary:#0ea5e9;--accent:#ef4444;
}
*{box-sizing:border-box}
html,body{height:100%}
body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
.header{position:sticky;top:0;background:var(--bg);padding:10px 12px;z-index:10}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
select,button{appearance:none;border:1px solid #e5e7eb;background:var(--card);padding:8px 10px;border-radius:10px;font-size:15px}
button{color:var(--text);background:var(--card);border:1px solid #e5e7eb}
.period-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.primary{background:var(--primary);color:#fff;border:none}
.container{padding:12px}
.section{margin-bottom:14px}
.card{background:var(--card);border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:10px}
.chart-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
.chart-inner{min-width:600px}
.title{margin:6px 0 8px 4px;font-size:18px;color:var(--muted)}
canvas{width:100% !important;height:300px !important}
@media(min-width:768px){canvas{height:360px !important}}
.status{margin:8px 4px;color:var(--muted)}
/* KPI cards */
.kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
@media(min-width:768px){.kpis{grid-template-columns:repeat(4,1fr)}}
.kpi{background:var(--card);border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.06);padding:10px}
.kpi .label{font-size:13px;color:var(--muted)}
.kpi .value{font-size:20px;font-weight:600;margin-top:6px}
.kpi .sub{font-size:12px;color:var(--muted);margin-top:4px}
.up{color:#16a34a}
.down{color:#ef4444}
</style>
</head>
<body>
<div class="header">
  <div class="toolbar">
    <select id="deviceSelect" onchange="loadData(currentPeriod)"></select>
    <button class="period-btn" data-period="day" onclick="loadData('day')">今天</button>
    <button class="period-btn" data-period="week" onclick="loadData('week')">近7天</button>
    <button class="period-btn" data-period="month" onclick="loadData('month')">近30天</button>
    <button class="primary" onclick="fetchData()">抓取</button>
  </div>
</div>
<div class="container">
  <div class="kpis">
    <div class="kpi">
      <div class="label">当前余额</div>
      <div class="value" id="kpi-balance">--</div>
      <div class="sub">单位：元</div>
    </div>
    <div class="kpi">
      <div class="label" id="kpi-usage-label">今日用电</div>
      <div class="value" id="kpi-today">--</div>
      <div class="sub">单位：度</div>
    </div>
    <div class="kpi">
      <div class="label" id="kpi-compare-label">较昨日</div>
      <div class="value" id="kpi-compare">--</div>
      <div class="sub" id="kpi-compare-sub"></div>
    </div>
    <div class="kpi">
      <div class="label">预计可用天数</div>
      <div class="value" id="kpi-days">--</div>
      <div class="sub">基于近7天日均</div>
    </div>
  </div>
  <div class="section">
    <div class="title">趋势</div>
    <div class="card">
      <div class="chart-scroll" id="chartScroll">
        <div class="chart-inner" id="chartInner">
          <canvas id="combinedChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  <p id="status" class="status"></p>
</div>
<script>
let devices = [];
const isMobile = window.matchMedia('(max-width: 768px)').matches;
let combinedChart;
let currentPeriod = 'day';

function populateDevices(){
  const sel = document.getElementById('deviceSelect');
  sel.innerHTML = devices.map(d=>`<option value="${d.id}">${d.name}</option>`).join('');
}

const commonOptions = {
  responsive:true,
  maintainAspectRatio:false,
  layout:{padding:{top:16,right:8,bottom:0,left:8}},
  interaction:{mode:'index',intersect:false},
  plugins:{
    legend:{display:false},
    tooltip:{
      enabled:true,
      callbacks:{label:(ctx)=>`${ctx.dataset.label}: ${Number(ctx.parsed.y??ctx.raw).toFixed(2)}`},
      bodyFont:{size:isMobile?12:13},
      titleFont:{size:isMobile?12:13}
    },
    datalabels:{
      display:(ctx)=>{
        // 仅在移动端显示每隔N个柱的标签，避免重叠
        const idx = ctx.dataIndex || 0;
        const total = ctx.chart.data.labels?.length || 0;
        const step = total>20 ? 5 : total>12 ? 3 : 2;
        return (idx % step)===0;
      },
      formatter:(v)=>Number(v).toFixed(2),
      color:'#111',
      backgroundColor:'rgba(255,255,255,0.85)',
      borderRadius:6,
      padding:{top:2,right:4,bottom:2,left:4},
      anchor:'end',align:'end',offset:-2,clamp:true
    }
  },
  scales:{
    y:{beginAtZero:true,grid:{color:'rgba(0,0,0,0.06)'},ticks:{callback:(v)=>Number(v).toFixed(2),font:{size:isMobile?11:12}}},
    x:{grid:{display:false},ticks:{maxRotation:0,autoSkip:true,autoSkipPadding:8,maxTicksLimit:isMobile?6:12,font:{size:isMobile?10:12}}}
  }
};

function renderCombinedChart(labels, balances, usage){
  // 依据数据点数量动态设置画布宽度，实现左右滑动
  const inner = document.getElementById('chartInner');
  const perPoint = isMobile ? 36 : 24; // 每个数据点占用像素，越大越不拥挤
  const minWidth = Math.max(inner.clientWidth, labels.length * perPoint + 80);
  inner.style.width = minWidth + 'px';

  const ctx = document.getElementById('combinedChart').getContext('2d');
  if(combinedChart) combinedChart.destroy();
  combinedChart = new Chart(ctx,{
    data:{
      labels,
      datasets:[
        { type:'bar', label:'用电量', yAxisID:'yUsage', data:usage,
          backgroundColor:'rgba(239,68,68,0.65)', borderColor:'rgba(239,68,68,1)', borderWidth:1,
          borderRadius:6, maxBarThickness:isMobile?18:32, categoryPercentage:0.5, barPercentage:0.8 },
        { type:'line', label:'余额', yAxisID:'yBalance', data:balances,
          borderColor:'rgba(14,165,233,1)', backgroundColor:'rgba(14,165,233,0.2)',
          tension:0.25, fill:true, pointRadius:0, borderWidth:2 }
      ]
    },
    options:{
      ...commonOptions,
      plugins:{
        ...commonOptions.plugins,
        datalabels:{
          ...commonOptions.plugins.datalabels,
          display:(ctx)=> ctx.dataset && ctx.dataset.yAxisID==='yUsage',
          formatter:(v)=> Number(v).toFixed(2)
        }
      },
      scales:{
        yBalance:{ position:'left', beginAtZero:true, grid:{ color:'rgba(0,0,0,0.06)' },
          ticks:{ callback:(v)=>Number(v).toFixed(2), font:{ size:isMobile?11:12 } } },
        yUsage:{ position:'right', beginAtZero:true, grid:{ display:false },
          ticks:{ callback:(v)=>Number(v).toFixed(2), font:{ size:isMobile?11:12 } } },
        x: { ...commonOptions.scales.x, ticks: { ...commonOptions.scales.x.ticks, maxRotation: 0, autoSkip: false } }
      }
    },
    plugins:[ChartDataLabels]
  });
}

function updateKpis(dayData, weekData){
  const fmt = (n)=>Number(n??0).toFixed(2);
  // 通过后端 /kpi 获取所需基准数据
  const deviceId = document.getElementById('deviceSelect').value;
  fetch(`/kpi?device_id=${deviceId}`).then(r=>r.json()).then(k=>{
    const currentBalance = Number(k.current_balance ?? 0);
    const todayUsage = Number(k.usage_today ?? 0);
    const yesterdayUsage = Number(k.usage_yesterday ?? 0);
    const rechargeToday = Number(k.recharge_today ?? 0);

    // 当前余额 = 当前剩余电量（1 元 = 1 度电）
    document.getElementById('kpi-balance').textContent = fmt(currentBalance);
    // 今日用电（充值感知后）
    document.getElementById('kpi-today').textContent = fmt(todayUsage);

    // 较昨日/较上周期
    const diffEl = document.getElementById('kpi-compare');
    const diffSub = document.getElementById('kpi-compare-sub');
    let diff = todayUsage - yesterdayUsage;
    let subText = `昨日 ${fmt(yesterdayUsage)}，今日 ${fmt(todayUsage)}${rechargeToday>0?`，充值 ${fmt(rechargeToday)}`:''}`;
    // 周/月改为“较上周期”，以接口 /period_kpi 计算
    if(currentPeriod !== 'day'){
      const deviceId = document.getElementById('deviceSelect').value;
      fetch(`/period_kpi?period=${currentPeriod}&device_id=${deviceId}`).then(r=>r.json()).then(pk=>{
        const cu = Number(pk.current_usage||0), pu = Number(pk.previous_usage||0);
        const d = cu - pu;
        diffEl.textContent = `${d>=0?'+':''}${fmt(d)}`;
        diffEl.className = 'value ' + (d>=0? 'up':'down');
        diffSub.textContent = `上周期 ${fmt(pu)}，本周期 ${fmt(cu)}`;
      });
    } else {
      diffEl.textContent = `${diff>=0?'+':''}${fmt(diff)}`;
      diffEl.className = 'value ' + (diff>=0? 'up':'down');
      diffSub.textContent = subText;
    }

    // 预计可用天数：以最近 7 天日均用电估算（仍保留原逻辑）
    const labelsW = weekData.labels||[]; const usageW = weekData.usage||[];
    const todayStr = new Date().toISOString().slice(0,10);
    const todayIdx = labelsW.indexOf(todayStr);
    const usageForAvg = usageW.filter((_,i)=> i>0 && i!==todayIdx).map(Number).filter(v=>v>0);
    const avg7 = usageForAvg.length ? (usageForAvg.reduce((a,b)=>a+b,0)/usageForAvg.length) : 0;
    const days = avg7>0 ? (currentBalance/avg7) : Infinity;
    document.getElementById('kpi-days').textContent = isFinite(days) ? fmt(days) : '∞';
  });
}

function loadData(period){
  currentPeriod = period;
  // 高亮当前周期按钮
  document.querySelectorAll('.period-btn').forEach(btn=>{
    if(btn.dataset.period === period){ btn.classList.add('active'); }
    else { btn.classList.remove('active'); }
  });
  const deviceId = document.getElementById('deviceSelect').value;
  Promise.all([
    fetch(`/data?period=${period}&device_id=${deviceId}`).then(r=>r.json()),
    fetch(`/data?period=day&device_id=${deviceId}`).then(r=>r.json()),
    fetch(`/data?period=week&device_id=${deviceId}`).then(r=>r.json())
  ]).then(([chartRes, dayRes, weekRes])=>{
    if(chartRes.labels.length===0) document.getElementById('status').innerText='暂无数据，先抓取或稍后再试';
    renderCombinedChart(chartRes.labels, chartRes.balances, chartRes.usage);
    updateKpis(dayRes, weekRes);
    // 更新用电/对比标签文案
    const labelEl = document.getElementById('kpi-usage-label');
    labelEl.textContent = period==='day' ? '今日用电' : (period==='week' ? '近7天用电' : '近30天用电');
    const compareLabel = document.getElementById('kpi-compare-label');
    compareLabel.textContent = period==='day' ? '较昨日' : '较上周期';
    // 更新 KPI 数值为对应周期总用电
    const totalUsage = (chartRes.usage||[]).reduce((a,b)=>a+Number(b||0),0);
    document.getElementById('kpi-today').textContent = Number(totalUsage).toFixed(2);
  });
}

function fetchData(){
  const deviceId = document.getElementById('deviceSelect').value;
  document.getElementById('status').innerText='抓取中...';
  fetch(`/fetch?device_id=${deviceId}`).then(r=>r.json()).then(res=>{
    document.getElementById('status').innerText=res.message;loadData(currentPeriod);
  });
}

document.addEventListener('DOMContentLoaded',()=>{
  const el = document.getElementById('devices-json');
  try { devices = JSON.parse(el ? el.textContent : '[]'); } catch(e) { devices = []; }
  populateDevices();
  loadData('day');
});
</script>
<script type="application/json" id="devices-json">{{ devices|tojson }}</script>
</body>
</html>